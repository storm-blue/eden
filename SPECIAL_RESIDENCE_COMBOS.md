# 🏠💕 特殊居住组合人口增长功能

## 功能概述

当特定用户组合居住在星星城的同一地点时，会触发特殊的人口增长加成：

- **两人组合**：李星斗 + 秦小淮 = 每小时人口增长 +1000
- **三人组合**：李星斗 + 秦小淮 + 存子 = 每小时人口增长 +1500

## 技术实现

### 后端架构

#### 1. SpecialResidenceService
- **位置**: `com.eden.lottery.service.SpecialResidenceService`
- **功能**: 
  - 检测当前所有居住地点的特殊组合
  - 计算总的每小时人口增长加成
  - 提供特殊组合的详细信息

#### 2. HourlyRefreshTask
- **位置**: `com.eden.lottery.task.HourlyRefreshTask`
- **功能**: 每小时执行特殊居住组合人口增长
- **执行时间**: 每小时的0分0秒 (`0 0 * * * ?`)

#### 3. StarCityService 扩展
- **新增方法**: `applyHourlyPopulationBonus(int bonusPopulation)`
- **功能**: 应用人口增长加成并重新计算城市等级

#### 4. StarCityMapper 扩展
- **新增方法**: `addPopulation(int population)`
- **SQL**: 直接增加指定数量的人口

### 前端显示

#### 1. 特殊组合状态显示
- **位置**: 星星城页面右下角的城市数据面板
- **显示内容**: 
  - 💕 爱情加成 💕
  - 每小时人口增长数量
  - 具体组合描述

#### 2. 实时状态更新
- 进入星星城时自动获取特殊组合状态
- 用户更换居住地点后自动刷新状态

## API 接口

### 获取特殊居住组合状态
```
GET /api/star-city/special-combos
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取特殊居住组合状态成功",
  "data": {
    "activeCombos": [
      {
        "residence": "castle",
        "residenceName": "🏰 城堡",
        "combo": "TRIPLE_COMBO",
        "description": "李星斗、秦小淮和存子的三人组合加成",
        "hourlyBonus": 1500,
        "members": ["李星斗", "秦小淮", "存子"]
      }
    ],
    "totalHourlyBonus": 1500,
    "hasSpecialCombos": true
  }
}
```

## 特殊组合规则

### 1. 两人组合 (COUPLE_COMBO)
- **成员**: 李星斗 + 秦小淮
- **条件**: 两人必须居住在同一地点，且该地点只有这两个人
- **加成**: 每小时人口 +1000
- **描述**: "李星斗和秦小淮的爱情加成"

### 2. 三人组合 (TRIPLE_COMBO)
- **成员**: 李星斗 + 秦小淮 + 存子
- **条件**: 三人必须居住在同一地点，且该地点只有这三个人
- **加成**: 每小时人口 +1500
- **描述**: "李星斗、秦小淮和存子的三人组合加成"
- **优先级**: 高于两人组合

## 执行机制

### 1. 定时任务执行
- **频率**: 每小时执行一次
- **执行时间**: 每小时的整点（如 1:00, 2:00, 3:00...）
- **执行逻辑**:
  1. 扫描所有居住地点
  2. 检测特殊组合
  3. 计算总人口增长加成
  4. 应用人口增长
  5. 重新计算城市等级

### 2. 实时状态更新
- 用户更换居住地点时立即更新特殊组合状态
- 前端显示实时反映当前的特殊组合情况

## 前端界面效果

### 1. 爱情加成显示
- **位置**: 星星城数据面板中
- **样式**: 粉色背景，带有爱心图标和发光动画
- **内容**: 
  - 标题: "💕 爱情加成 💕"
  - 数值: "每小时人口 +[数量]"
  - 详情: 各个组合的具体描述

### 2. 飘动爱心效果
- 当建筑中有特殊组合时，建筑上方会显示飘动的红心 💗
- 动画效果: 上下浮动，带有透明度变化

## 测试方法

运行测试脚本：
```bash
./test-special-combos.sh
```

### 手动测试步骤：
1. 启动后端服务
2. 创建用户：李星斗、秦小淮、存子
3. 让李星斗和秦小淮居住在同一地点
4. 访问星星城页面，查看是否显示两人组合加成
5. 让存子也住进同一地点
6. 刷新页面，查看是否显示三人组合加成
7. 等待一小时或手动触发定时任务，查看人口是否增长

## 日志监控

### 关键日志信息
- `SpecialResidenceService`: 特殊组合检测结果
- `HourlyRefreshTask`: 每小时任务执行情况
- `StarCityService`: 人口增长应用结果

### 示例日志
```
INFO  - 检测到特殊居住组合：李星斗、秦小淮和存子的三人组合加成 在 🏰 城堡 - 人口加成: +1500/小时
INFO  - 当前特殊居住组合总人口加成：+1500/小时
INFO  - 应用特殊居住组合人口加成：+1500 人口，当前人口：101500
```

## 注意事项

1. **唯一性**: 每个地点只能有一个特殊组合生效
2. **优先级**: 三人组合优先于两人组合
3. **精确匹配**: 必须是指定的用户名，大小写敏感
4. **地点限制**: 特殊组合成员必须全部在同一地点
5. **实时更新**: 居住变更会立即影响特殊组合状态
6. **累加效果**: 如果多个地点都有特殊组合，加成会累加

## 扩展性

当前设计支持轻松添加新的特殊组合：
1. 在 `SpecialCombo` 枚举中添加新组合
2. 在 `detectSpecialCombo` 方法中添加检测逻辑
3. 无需修改其他代码，系统会自动处理新组合
