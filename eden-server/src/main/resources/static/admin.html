<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸª EdenæŠ½å¥–ç³»ç»Ÿ - ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* ç™»å½•è¡¨å•æ ·å¼ */
        .login-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
        }

        .login-title {
            text-align: center;
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        /* ç®¡ç†ç•Œé¢æ ·å¼ */
        .admin-panel {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .admin-header h2 {
            color: #333;
            font-size: 24px;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .action-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .action-form h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .filter-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .stats-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .stats-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }

        .badge-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .badge-secondary {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        .badge-primary {
            background-color: #bee5eb;
            color: #0c5460;
            border: 1px solid #abdde5;
        }

        .badge-warning {
            background-color: #ffeaa7;
            color: #856404;
            border: 1px solid #ffd93d;
        }

        /* åˆ†é¡µæ ·å¼ */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-controls .btn {
            padding: 6px 12px;
            font-size: 14px;
            min-width: 60px;
        }

        .pagination-controls .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
            margin: 0 10px;
        }

        .page-number {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 32px;
            text-align: center;
        }

        .page-number:hover {
            background: #e9ecef;
        }

        .page-number.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }

        .form-field {
            flex: 1;
        }

        .form-field label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        .form-field input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .action-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #5a67d8;
        }

        .delete-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #c53030;
            transform: translateY(-1px);
        }

        .delete-btn:active {
            transform: translateY(0);
        }

        .message {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .tabs {
                flex-wrap: wrap;
            }

        .tab {
            flex: 1;
            min-width: 120px;
        }

        /* ç”¨æˆ·ç®€ä»‹å’ŒçŠ¶æ€ç¼–è¾‘æ ·å¼ */
        .profile-cell, .status-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 200px;
        }

        .profile-text, .status-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .edit-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            min-width: 30px;
            transition: background-color 0.3s;
        }

        .edit-btn:hover {
            background: #45a049;
        }

        .profile-text {
            color: #666;
            font-style: italic;
        }

        .status-text {
            color: #2196F3;
            font-weight: 500;
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª EdenæŠ½å¥–ç³»ç»Ÿ</h1>
            <p>ç®¡ç†åå°æ§åˆ¶é¢æ¿</p>
        </div>

        <!-- ç™»å½•è¡¨å• -->
        <div id="loginContainer" class="login-container">
            <h2 class="login-title">ç®¡ç†å‘˜ç™»å½•</h2>
            <div id="loginMessage"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">ç™»å½•</button>
            </form>
        </div>

        <!-- ç®¡ç†é¢æ¿ -->
        <div id="adminPanel" class="admin-panel">
            <div class="admin-header">
                <h2>ç®¡ç†æ§åˆ¶é¢æ¿</h2>
                <button id="logoutBtn" class="logout-btn">é€€å‡ºç™»å½•</button>
            </div>

            <div id="adminMessage"></div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalUsers">-</h3>
                    <p>æ€»ç”¨æˆ·æ•°</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeUsers">-</h3>
                    <p>æ´»è·ƒç”¨æˆ·</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalDraws">-</h3>
                    <p>æ€»æŠ½å¥–æ¬¡æ•°</p>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="tabs">
                <button class="tab active" data-tab="users">ç”¨æˆ·ç®¡ç†</button>
                <button class="tab" data-tab="history">æŠ½å¥–å†å²</button>
                <button class="tab" data-tab="wishes">æ„¿æœ›ç®¡ç†</button>
                <button class="tab" data-tab="residence">å±…ä½å†å²</button>
                <button class="tab" data-tab="attempts">ç”¨æˆ·å°è¯•è®°å½•</button>
                <button class="tab" data-tab="actions">ç”¨æˆ·æ“ä½œ</button>
                <button class="tab" data-tab="residence-events">å±…æ‰€äº‹ä»¶</button>
                <button class="tab" data-tab="decrees">å‘½ä»¤ç®¡ç†</button>
                <button class="tab" data-tab="magic">é­”æ³•ç®¡ç†</button>
                <button class="tab" data-tab="giant-attack">å·¨äººè¿›æ”»ç®¡ç†</button>
            </div>

            <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="users" class="tab-content active">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·ID</th>
                                <th>å‰©ä½™æ¬¡æ•°</th>
                                <th>æ¯æ—¥æ¬¡æ•°</th>
                                <th>ç®€ä»‹</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æœ€ååˆ·æ–°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr><td colspan="8" style="text-align: center; padding: 20px;">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æŠ½å¥–å†å²æ ‡ç­¾é¡µ -->
            <div id="history" class="tab-content">
                <!-- ç­›é€‰å’Œåˆ†é¡µæ§åˆ¶ -->
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyUserId">ç”¨æˆ·IDç­›é€‰:</label>
                            <input type="text" id="historyUserId" placeholder="è¾“å…¥ç”¨æˆ·IDè¿›è¡Œç­›é€‰">
                        </div>
                        <div class="form-group">
                            <label for="historyPageSize">æ¯é¡µæ¡æ•°:</label>
                            <select id="historyPageSize">
                                <option value="10">10æ¡</option>
                                <option value="20" selected>20æ¡</option>
                                <option value="50">50æ¡</option>
                                <option value="100">100æ¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button onclick="loadHistory(1)" class="btn btn-primary">ğŸ” æŸ¥è¯¢</button>
                            <button onclick="clearHistoryFilter()" class="btn btn-secondary">ğŸ”„ æ¸…é™¤ç­›é€‰</button>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®è¡¨æ ¼ -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·ID</th>
                                <th>å¥–å“</th>
                                <th>ç­‰çº§</th>
                                <th>IPåœ°å€</th>
                                <th>æŠ½å¥–æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <tr><td colspan="6" style="text-align: center; padding: 20px;">ç‚¹å‡»æŸ¥è¯¢åŠ è½½æ•°æ®</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µå¯¼èˆª -->
                <div class="pagination-container" id="historyPagination" style="display: none;">
                    <div class="pagination-info">
                        <span id="historyPaginationInfo">æ˜¾ç¤ºç¬¬ 1-20 æ¡ï¼Œå…± 0 æ¡è®°å½•</span>
                    </div>
                    <div class="pagination-controls">
                        <button id="historyFirstPage" onclick="loadHistory(1)" class="btn btn-sm">é¦–é¡µ</button>
                        <button id="historyPrevPage" onclick="loadHistoryPrevPage()" class="btn btn-sm">ä¸Šä¸€é¡µ</button>
                        <span class="page-numbers" id="historyPageNumbers"></span>
                        <button id="historyNextPage" onclick="loadHistoryNextPage()" class="btn btn-sm">ä¸‹ä¸€é¡µ</button>
                        <button id="historyLastPage" onclick="loadHistoryLastPage()" class="btn btn-sm">æœ«é¡µ</button>
                    </div>
                </div>
            </div>

            <!-- æ„¿æœ›ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="wishes" class="tab-content">
                <!-- æ„¿æœ›ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-section">
                    <h4>âœ¨ æ„¿æœ›ç»Ÿè®¡</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalWishes">-</h3>
                            <p>æ€»æ„¿æœ›æ•°</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="wishStatsMessage">-</h3>
                            <p>æ˜Ÿç©ºçŠ¶æ€</p>
                        </div>
                    </div>
                </div>

                <!-- æ„¿æœ›åˆ—è¡¨ -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·ID</th>
                                <th>æ„¿æœ›å†…å®¹</th>
                                <th>æ˜Ÿæ˜Ÿä½ç½®</th>
                                <th>æ˜Ÿæ˜Ÿå¤§å°</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="wishesTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">ç‚¹å‡»åŠ è½½æ„¿æœ›æ•°æ®</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- åŠ è½½æŒ‰é’® -->
                <div class="action-form">
                    <div class="form-row">
                        <button onclick="loadWishes()" class="action-btn">ğŸ”„ åˆ·æ–°æ„¿æœ›åˆ—è¡¨</button>
                        <button onclick="loadWishStats()" class="action-btn">ğŸ“Š æ›´æ–°ç»Ÿè®¡</button>
                    </div>
                </div>
            </div>

            <!-- å±…ä½å†å²æ ‡ç­¾é¡µ -->
            <div id="residence" class="tab-content">
                <!-- å±…ä½å†å²ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-section">
                    <h4>ğŸ  å±…ä½å†å²ç»Ÿè®¡</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalMoves">-</h3>
                            <p>æ€»æ¬è¿æ¬¡æ•°</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="residenceStatsMessage">-</h3>
                            <p>æ´»è·ƒçŠ¶æ€</p>
                        </div>
                    </div>
                </div>

                <!-- è¿‡æ»¤é€‰é¡¹ -->
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="residenceUserId">ç”¨æˆ·IDç­›é€‰:</label>
                            <input type="text" id="residenceUserId" placeholder="è¾“å…¥ç”¨æˆ·IDè¿›è¡Œç­›é€‰">
                        </div>
                        <div class="form-group">
                            <label for="residenceLocation">å±…ä½åœ°ç‚¹ç­›é€‰:</label>
                            <select id="residenceLocation">
                                <option value="">å…¨éƒ¨åœ°ç‚¹</option>
                                <option value="castle">ğŸ° åŸå ¡</option>
                                <option value="city_hall">ğŸ›ï¸ å¸‚æ”¿å…</option>
                                <option value="palace">ğŸ¯ è¡Œå®«</option>
                                <option value="white_dove_house">ğŸ•Šï¸ å°ç™½é¸½å®¶</option>
                                <option value="park">ğŸŒ³ å…¬å›­</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- å±…ä½å†å²åˆ—è¡¨ -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·ID</th>
                                <th>æ¬è¿å‰</th>
                                <th>æ¬è¿å</th>
                                <th>æ¬è¿æ—¶é—´</th>
                                <th>IPåœ°å€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="residenceHistoryTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">ç‚¹å‡»åŠ è½½å±…ä½å†å²æ•°æ®</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µæ§ä»¶ -->
                <div class="pagination-section">
                    <div class="pagination-info">
                        <span id="residencePageInfo">ç¬¬ 1 é¡µï¼Œå…± 0 æ¡è®°å½•</span>
                    </div>
                    <div class="pagination-controls">
                        <button id="residencePrevPage" onclick="changeResidencePage(-1)" disabled>ä¸Šä¸€é¡µ</button>
                        <span id="residenceCurrentPage">1</span>
                        <button id="residenceNextPage" onclick="changeResidencePage(1)" disabled>ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>

                <!-- åŠ è½½æŒ‰é’® -->
                <div class="action-form">
                    <div class="form-row">
                        <button onclick="loadResidenceHistory()" class="action-btn">ğŸ”„ åˆ·æ–°å±…ä½å†å²</button>
                        <button onclick="loadResidenceStats()" class="action-btn">ğŸ“Š æ›´æ–°ç»Ÿè®¡</button>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·å°è¯•è®°å½•æ ‡ç­¾é¡µ -->
            <div id="attempts" class="tab-content">
                <!-- è¿‡æ»¤é€‰é¡¹ -->
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="attemptUserId">ç”¨æˆ·IDç­›é€‰:</label>
                            <input type="text" id="attemptUserId" placeholder="è¾“å…¥ç”¨æˆ·IDè¿›è¡Œç­›é€‰">
                        </div>
                        <div class="form-group">
                            <label for="attemptHours">æ—¶é—´èŒƒå›´:</label>
                            <select id="attemptHours">
                                <option value="1">æœ€è¿‘1å°æ—¶</option>
                                <option value="6">æœ€è¿‘6å°æ—¶</option>
                                <option value="24" selected>æœ€è¿‘24å°æ—¶</option>
                                <option value="72">æœ€è¿‘3å¤©</option>
                                <option value="168">æœ€è¿‘7å¤©</option>
                                <option value="0">å…¨éƒ¨è®°å½•</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="attemptLimit">æ˜¾ç¤ºæ¡æ•°:</label>
                            <select id="attemptLimit">
                                <option value="50">50æ¡</option>
                                <option value="100" selected>100æ¡</option>
                                <option value="200">200æ¡</option>
                                <option value="500">500æ¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button onclick="loadAttempts()" class="btn btn-primary">ğŸ” æŸ¥è¯¢</button>
                            <button onclick="loadAttemptStats()" class="btn btn-secondary">ğŸ“Š ç»Ÿè®¡</button>
                        </div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div id="attemptStatsSection" class="stats-section" style="display: none;">
                    <h4>ğŸ“Š ç”¨æˆ·å°è¯•ç»Ÿè®¡</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalAttempts">-</h3>
                            <p>æ€»å°è¯•æ¬¡æ•°</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="existentUserAttempts">-</h3>
                            <p>å·²å­˜åœ¨ç”¨æˆ·å°è¯•</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="nonExistentUserAttempts">-</h3>
                            <p>ä¸å­˜åœ¨ç”¨æˆ·å°è¯•</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="nonExistentRate">-</h3>
                            <p>ä¸å­˜åœ¨ç”¨æˆ·æ¯”ä¾‹</p>
                        </div>
                    </div>
                </div>

                <!-- å°è¯•è®°å½•è¡¨æ ¼ -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·ID</th>
                                <th>ç”¨æˆ·å­˜åœ¨</th>
                                <th>IPåœ°å€</th>
                                <th>ç”¨æˆ·ä»£ç†</th>
                                <th>å°è¯•æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="attemptsTableBody">
                            <!-- åŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>

                <!-- æ¸…ç†æ“ä½œ -->
                <div class="action-form">
                    <h4>ğŸ—‘ï¸ æ¸…ç†æ—§è®°å½•</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cleanupDays">æ¸…ç†å¤©æ•°:</label>
                            <select id="cleanupDays">
                                <option value="7">7å¤©å‰</option>
                                <option value="30" selected>30å¤©å‰</option>
                                <option value="90">90å¤©å‰</option>
                                <option value="365">1å¹´å‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button onclick="cleanupAttempts()" class="btn btn-danger">ğŸ—‘ï¸ æ¸…ç†è®°å½•</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·æ“ä½œæ ‡ç­¾é¡µ -->
            <div id="actions" class="tab-content">
                <!-- æ·»åŠ ç”¨æˆ· -->
                <div class="action-form">
                    <h4>ğŸ“ æ·»åŠ æ–°ç”¨æˆ·</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="newUserId">ç”¨æˆ·IDï¼ˆå§“åï¼‰</label>
                            <input type="text" id="newUserId" placeholder="è¯·è¾“å…¥ç”¨æˆ·å§“å">
                        </div>
                        <div class="form-field">
                            <label for="newUserDaily">æ¯æ—¥æŠ½å¥–æ¬¡æ•°</label>
                            <input type="number" id="newUserDaily" placeholder="é»˜è®¤3æ¬¡" min="1" max="10">
                        </div>
                        <button class="action-btn" onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>
                    </div>
                </div>

                <!-- å¢åŠ æŠ½å¥–æ¬¡æ•° -->
                <div class="action-form">
                    <h4>ğŸ¯ å¢åŠ ç”¨æˆ·æŠ½å¥–æ¬¡æ•°</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="addDrawsUserId">ç”¨æˆ·ID</label>
                            <input type="text" id="addDrawsUserId" placeholder="è¯·è¾“å…¥ç”¨æˆ·å§“å">
                        </div>
                        <div class="form-field">
                            <label for="addDrawsAmount">å¢åŠ æ¬¡æ•°</label>
                            <input type="number" id="addDrawsAmount" placeholder="1" min="1" max="100">
                        </div>
                        <button class="action-btn" onclick="addUserDraws()">å¢åŠ æ¬¡æ•°</button>
                    </div>
                </div>

                <!-- è®¾ç½®æ¯æ—¥æ¬¡æ•° -->
                <div class="action-form">
                    <h4>âš™ï¸ è®¾ç½®ç”¨æˆ·æ¯æ—¥æŠ½å¥–æ¬¡æ•°</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="setDailyUserId">ç”¨æˆ·ID</label>
                            <input type="text" id="setDailyUserId" placeholder="è¯·è¾“å…¥ç”¨æˆ·å§“å">
                        </div>
                        <div class="form-field">
                            <label for="setDailyAmount">æ¯æ—¥æ¬¡æ•°</label>
                            <input type="number" id="setDailyAmount" placeholder="3" min="1" max="10">
                        </div>
                        <button class="action-btn" onclick="setUserDailyDraws()">è®¾ç½®æ¬¡æ•°</button>
                    </div>
                </div>
            </div>

            <!-- å±…æ‰€äº‹ä»¶ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="residence-events" class="tab-content">
                <!-- å±…æ‰€äº‹ä»¶å†å²æ¦‚è§ˆ -->
                <div class="action-form">
                    <h4>ğŸ  å±…æ‰€äº‹ä»¶å†å²æ¦‚è§ˆ</h4>
                    <div id="residenceOverview" style="margin-top: 15px;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            ç‚¹å‡»åˆ·æ–°æŒ‰é’®åŠ è½½æ•°æ®
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="action-btn" onclick="loadResidenceEventOverview()">ğŸ”„ åˆ·æ–°æ¦‚è§ˆ</button>
                    </div>
                </div>

                <!-- æ¸…é™¤å±…æ‰€äº‹ä»¶å†å² -->
                <div class="action-form">
                    <h4>ğŸ—‘ï¸ æ¸…é™¤å±…æ‰€äº‹ä»¶å†å²</h4>
                    <p style="color: #e53e3e; margin-bottom: 15px; font-size: 14px;">
                        âš ï¸ è­¦å‘Šï¼šæ¸…é™¤æ“ä½œä¸å¯é€†ï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼
                    </p>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="clearResidence">é€‰æ‹©å±…æ‰€</label>
                            <select id="clearResidence" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="">è¯·é€‰æ‹©è¦æ¸…é™¤çš„å±…æ‰€</option>
                                <option value="castle">åŸå ¡ğŸ°</option>
                                <option value="park">å…¬å›­ğŸŒ³</option>
                                <option value="city_hall">å¸‚æ”¿å…ğŸ›ï¸</option>
                                <option value="white_dove_house">å°ç™½é¸½å®¶ğŸ•Šï¸</option>
                                <option value="palace">è¡Œå®«ğŸ¯</option>
                            </select>
                        </div>
                        <button class="action-btn" onclick="clearResidenceEventHistory()" style="background: #e53e3e;">
                            ğŸ—‘ï¸ æ¸…é™¤å†å²
                        </button>
                    </div>
                </div>
            </div>

            <!-- å‘½ä»¤ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="decrees" class="tab-content">
                <div class="action-form">
                    <h4>ğŸ“œ å‘½ä»¤ç®¡ç†</h4>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        ç®¡ç†ç³»ç»Ÿå‘½ä»¤çš„åç§°å’Œæè¿°ä¿¡æ¯
                    </p>
                    <div id="decreesTable" style="margin-top: 15px;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- é­”æ³•ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="magic" class="tab-content">
                <div class="action-form">
                    <h4>âœ¨ é­”æ³•ç®¡ç†</h4>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        ç®¡ç†é­”æ³•çš„ç²¾åŠ›æ¶ˆè€—å€¼ï¼ˆæ³¨æ„ï¼šå·²ç§»é™¤æ¯æ—¥æ¬¡æ•°é™åˆ¶ï¼Œä»…ç²¾åŠ›é™åˆ¶ç”Ÿæ•ˆï¼‰
                    </p>
                    <div id="magicTable" style="margin-top: 15px;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- å·¨äººè¿›æ”»ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="giant-attack" class="tab-content">
                <!-- å·¨äººè¿›æ”»çŠ¶æ€ -->
                <div class="stats-section">
                    <h4>ğŸ‘¹ å·¨äººè¿›æ”»çŠ¶æ€</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="giantAttackStatus">-</h3>
                            <p>å½“å‰çŠ¶æ€</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="giantAttackTime">-</h3>
                            <p>è¿›æ”»æ—¶é—´</p>
                        </div>
                    </div>
                </div>

                <!-- å·¨äººè¿›æ”»æ§åˆ¶ -->
                <div class="action-form">
                    <h4>ğŸ® å·¨äººè¿›æ”»æ§åˆ¶</h4>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        æ‰‹åŠ¨æ§åˆ¶å·¨äººè¿›æ”»çš„å¼€å§‹å’Œç»“æŸ
                    </p>
                    <div class="form-row">
                        <button onclick="triggerGiantAttack()" class="action-btn" style="background: #e53e3e;">
                            ğŸ‘¹ è§¦å‘å·¨äººè¿›æ”»
                        </button>
                        <button onclick="endGiantAttack()" class="action-btn" style="background: #48bb78;">
                            ğŸ›¡ï¸ ç»“æŸå·¨äººè¿›æ”»
                        </button>
                        <button onclick="processGiantDamage()" class="action-btn" style="background: #ed8936;">
                            âš”ï¸ å¤„ç†å·¨äººä¼¤å®³
                        </button>
                        <button onclick="loadGiantAttackStatus()" class="action-btn">
                            ğŸ”„ åˆ·æ–°çŠ¶æ€
                        </button>
                    </div>
                </div>

                <!-- å·¨äººè¿›æ”»å†å² -->
                <div class="action-form">
                    <h4>ğŸ“Š å·¨äººè¿›æ”»å†å²</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å¼€å§‹æ—¶é—´</th>
                                    <th>ç»“æŸæ—¶é—´</th>
                                    <th>æœ€åä¼¤å®³æ—¶é—´</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="giantAttackHistoryTable">
                                <tr><td colspan="6" style="text-align: center; padding: 20px;">ç‚¹å‡»åˆ·æ–°çŠ¶æ€åŠ è½½æ•°æ®</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let adminToken = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„token
            adminToken = localStorage.getItem('adminToken');
            if (adminToken) {
                validateTokenAndShowAdmin();
            }

            // ç»‘å®šäº‹ä»¶
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
        });

        // å¤„ç†ç™»å½•
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (result.success) {
                    adminToken = result.data.token;
                    localStorage.setItem('adminToken', adminToken);
                    showMessage('loginMessage', 'ç™»å½•æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        showAdminPanel();
                    }, 1000);
                } else {
                    showMessage('loginMessage', result.message || 'ç™»å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showMessage('loginMessage', 'ç½‘ç»œè¿æ¥å¤±è´¥', 'error');
            }
        }

        // éªŒè¯tokenå¹¶æ˜¾ç¤ºç®¡ç†é¢æ¿
        async function validateTokenAndShowAdmin() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    showAdminPanel();
                } else {
                    // Tokenæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
                    localStorage.removeItem('adminToken');
                    adminToken = null;
                }
            } catch (error) {
                console.error('TokenéªŒè¯é”™è¯¯:', error);
                localStorage.removeItem('adminToken');
                adminToken = null;
            }
        }

        // æ˜¾ç¤ºç®¡ç†é¢æ¿
        function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadStats();
            loadUsers();
        }

        // å¤„ç†ç™»å‡º
        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/admin/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
            } catch (error) {
                console.error('ç™»å‡ºé”™è¯¯:', error);
            }

            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });

            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'attempts') {
                loadAttempts();
            } else if (tabName === 'wishes') {
                loadWishes();
                loadWishStats();
            } else if (tabName === 'residence') {
                loadResidenceHistory();
                loadResidenceStats();
            } else if (tabName === 'residence-events') {
                loadResidenceEventOverview();
            } else if (tabName === 'decrees') {
                loadDecrees();
            } else if (tabName === 'magic') {
                loadMagics();
            } else if (tabName === 'giant-attack') {
                loadGiantAttackStatus();
            }
        }

        // åŠ è½½å‘½ä»¤åˆ—è¡¨
        async function loadDecrees() {
            try {
                const response = await fetch(`${API_BASE}/admin/decrees`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    displayDecrees(data.data);
                } else {
                    document.getElementById('decreesTable').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e53e3e;">
                            ${data.message || 'åŠ è½½å‘½ä»¤å¤±è´¥'}
                        </div>`;
                }
            } catch (error) {
                console.error('åŠ è½½å‘½ä»¤å¤±è´¥:', error);
                document.getElementById('decreesTable').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e53e3e;">
                        åŠ è½½å‘½ä»¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                    </div>`;
            }
        }

        // æ˜¾ç¤ºå‘½ä»¤åˆ—è¡¨
        function displayDecrees(decrees) {
            if (!decrees || decrees.length === 0) {
                document.getElementById('decreesTable').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        æš‚æ— å‘½ä»¤
                    </div>`;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
            
            decrees.forEach(decree => {
                const statusBadge = decree.active ? 
                    '<span style="background: #48bb78; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px;">å·²æ¿€æ´»</span>' :
                    '<span style="background: #cbd5e0; color: #4a5568; padding: 3px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px;">æœªæ¿€æ´»</span>';

                html += `
                    <div style="border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 5px 0; font-size: 18px; color: #2d3748;">
                                    ${decree.name || 'æœªå‘½å'}
                                    ${statusBadge}
                                </h5>
                                <p style="margin: 0; font-size: 12px; color: #a0aec0;">
                                    ä»£ç : ${decree.code}
                                </p>
                            </div>
                            <button class="action-btn" onclick="editDecree('${decree.code}')" style="padding: 8px 16px; font-size: 14px;">
                                âœï¸ ç¼–è¾‘
                            </button>
                        </div>
                        <div style="background: #f7fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #667eea;">
                            <p style="margin: 0; font-size: 14px; color: #4a5568; line-height: 1.6;">
                                ${decree.description || 'æ— æè¿°'}
                            </p>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('decreesTable').innerHTML = html;
        }

        // ç¼–è¾‘å‘½ä»¤
        function editDecree(code) {
            fetch(`${API_BASE}/admin/decrees`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    const decree = data.data.find(d => d.code === code);
                    if (decree) {
                        showDecreeEditDialog(decree);
                    }
                }
            });
        }

        // æ˜¾ç¤ºå‘½ä»¤ç¼–è¾‘å¯¹è¯æ¡†
        function showDecreeEditDialog(decree) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);">
                    <h3 style="margin: 0 0 20px 0; color: #2d3748;">ç¼–è¾‘å‘½ä»¤ä¿¡æ¯</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: bold;">å‘½ä»¤ä»£ç ï¼ˆä¸å¯ä¿®æ”¹ï¼‰</label>
                        <input type="text" value="${decree.code}" disabled style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f7fafc; color: #a0aec0;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: bold;">å‘½ä»¤åç§° *</label>
                        <input type="text" id="decreeName" value="${decree.name || ''}" placeholder="è¾“å…¥å‘½ä»¤åç§°" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: bold;">å‘½ä»¤æè¿°</label>
                        <textarea id="decreeDescription" placeholder="è¾“å…¥å‘½ä»¤æè¿°" style="width: 100%; min-height: 120px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; resize: vertical;">${decree.description || ''}</textarea>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="padding: 10px 20px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #4a5568; cursor: pointer; font-size: 14px;">
                            å–æ¶ˆ
                        </button>
                        <button onclick="saveDecree('${decree.code}')" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; font-size: 14px; font-weight: bold;">
                            ä¿å­˜
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ä¿å­˜å‘½ä»¤
        async function saveDecree(code) {
            const name = document.getElementById('decreeName').value.trim();
            const description = document.getElementById('decreeDescription').value.trim();

            if (!name) {
                alert('å‘½ä»¤åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/decree/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        code: code,
                        name: name,
                        description: description
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('å‘½ä»¤ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    // å…³é—­å¯¹è¯æ¡†
                    document.querySelector('div[style*="position: fixed"]').remove();
                    // é‡æ–°åŠ è½½å‘½ä»¤åˆ—è¡¨
                    loadDecrees();
                } else {
                    alert('æ›´æ–°å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¿å­˜å‘½ä»¤å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('totalUsers').textContent = result.data.totalUsers;
                    document.getElementById('activeUsers').textContent = result.data.totalActiveUsers;
                    document.getElementById('totalDraws').textContent = result.data.lotteryStats.totalDraws;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯é”™è¯¯:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tbody = document.getElementById('usersTable');
                    tbody.innerHTML = '';

                    result.data.forEach(user => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${user.userId}</td>
                            <td>${user.remainingDraws}</td>
                            <td>${user.dailyDraws}</td>
                            <td>
                                <div class="profile-cell">
                                    <span class="profile-text" title="${user.profile || 'è¿™ä¸ªäººå¾ˆç¥ç§˜ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}">${truncateText(user.profile || 'è¿™ä¸ªäººå¾ˆç¥ç§˜ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...', 20)}</span>
                                    <button class="edit-btn" onclick="editUserProfile('${user.userId}', '${escapeHtml(user.profile || '')}')" title="ç¼–è¾‘ç®€ä»‹">âœï¸</button>
                                </div>
                            </td>
                            <td>
                                <div class="status-cell">
                                    <span class="status-text">${user.status || 'å®‰å±…ä¹ä¸šä¸­'}</span>
                                    <button class="edit-btn" onclick="editUserStatus('${user.userId}', '${escapeHtml(user.status || '')}')" title="ç¼–è¾‘çŠ¶æ€">âœï¸</button>
                                </div>
                            </td>
                            <td>${new Date(user.createTime).toLocaleString()}</td>
                            <td>${new Date(user.lastRefreshDate).toLocaleString()}</td>
                            <td>
                                <button class="delete-btn" onclick="deleteUser('${user.userId}')" title="åˆ é™¤ç”¨æˆ·">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨é”™è¯¯:', error);
            }
        }

        // åˆ†é¡µç›¸å…³å˜é‡
        let currentHistoryPage = 1;
        let historyPageSize = 20;
        let historyTotalPages = 1;
        let historyTotalCount = 0;

        // åŠ è½½æŠ½å¥–å†å²ï¼ˆåˆ†é¡µï¼‰
        async function loadHistory(page = 1) {
            try {
                const userId = document.getElementById('historyUserId').value.trim();
                const pageSize = document.getElementById('historyPageSize').value;
                
                let url = `${API_BASE}/admin/lottery-history?page=${page}&size=${pageSize}`;
                if (userId) {
                    url += `&userId=${encodeURIComponent(userId)}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    
                    // æ›´æ–°åˆ†é¡µå˜é‡
                    currentHistoryPage = data.pagination.currentPage;
                    historyPageSize = data.pagination.pageSize;
                    historyTotalPages = data.pagination.totalPages;
                    historyTotalCount = data.pagination.totalCount;

                    // æ›´æ–°è¡¨æ ¼å†…å®¹
                    const tbody = document.getElementById('historyTable');
                    tbody.innerHTML = '';

                    if (data.records.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">æš‚æ— æ•°æ®</td></tr>';
                    } else {
                        data.records.forEach(record => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${record.id}</td>
                                <td><strong>${record.userId}</strong></td>
                                <td>${record.prizeName}</td>
                                <td><span class="badge badge-${getBadgeClass(record.prizeLevel)}">${record.prizeLevel}</span></td>
                                <td>${record.ipAddress || '-'}</td>
                                <td>${new Date(record.createTime).toLocaleString()}</td>
                            `;
                        });
                    }

                    // æ›´æ–°åˆ†é¡µä¿¡æ¯
                    updateHistoryPagination();
                    
                    // æ˜¾ç¤ºåˆ†é¡µæ§ä»¶
                    document.getElementById('historyPagination').style.display = 'flex';
                } else {
                    showMessage('adminMessage', result.message || 'åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æŠ½å¥–å†å²é”™è¯¯:', error);
                showMessage('adminMessage', 'åŠ è½½æŠ½å¥–å†å²å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°åˆ†é¡µä¿¡æ¯å’Œæ§ä»¶
        function updateHistoryPagination() {
            // æ›´æ–°åˆ†é¡µä¿¡æ¯æ–‡æœ¬
            const startRecord = (currentHistoryPage - 1) * historyPageSize + 1;
            const endRecord = Math.min(currentHistoryPage * historyPageSize, historyTotalCount);
            document.getElementById('historyPaginationInfo').textContent = 
                `æ˜¾ç¤ºç¬¬ ${startRecord}-${endRecord} æ¡ï¼Œå…± ${historyTotalCount} æ¡è®°å½•`;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('historyFirstPage').disabled = currentHistoryPage === 1;
            document.getElementById('historyPrevPage').disabled = currentHistoryPage === 1;
            document.getElementById('historyNextPage').disabled = currentHistoryPage === historyTotalPages;
            document.getElementById('historyLastPage').disabled = currentHistoryPage === historyTotalPages;

            // æ›´æ–°é¡µç 
            updateHistoryPageNumbers();
        }

        // æ›´æ–°é¡µç æ˜¾ç¤º
        function updateHistoryPageNumbers() {
            const pageNumbers = document.getElementById('historyPageNumbers');
            pageNumbers.innerHTML = '';

            const maxShowPages = 5;
            let startPage = Math.max(1, currentHistoryPage - Math.floor(maxShowPages / 2));
            let endPage = Math.min(historyTotalPages, startPage + maxShowPages - 1);

            if (endPage - startPage + 1 < maxShowPages) {
                startPage = Math.max(1, endPage - maxShowPages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('span');
                pageBtn.className = `page-number ${i === currentHistoryPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => loadHistory(i);
                pageNumbers.appendChild(pageBtn);
            }
        }

        // åˆ†é¡µå¯¼èˆªå‡½æ•°
        function loadHistoryPrevPage() {
            if (currentHistoryPage > 1) {
                loadHistory(currentHistoryPage - 1);
            }
        }

        function loadHistoryNextPage() {
            if (currentHistoryPage < historyTotalPages) {
                loadHistory(currentHistoryPage + 1);
            }
        }

        function loadHistoryLastPage() {
            loadHistory(historyTotalPages);
        }

        // æ¸…é™¤ç­›é€‰
        function clearHistoryFilter() {
            document.getElementById('historyUserId').value = '';
            document.getElementById('historyPageSize').value = '20';
            loadHistory(1);
        }

        // è·å–å¾½ç« æ ·å¼ç±»
        function getBadgeClass(level) {
            const levelMap = {
                'common': 'secondary',
                'uncommon': 'primary', 
                'rare': 'warning',
                'epic': 'danger',
                'special': 'success'
            };
            return levelMap[level] || 'secondary';
        }

        // æ·»åŠ ç”¨æˆ·
        async function addUser() {
            const userId = document.getElementById('newUserId').value.trim();
            const dailyDraws = parseInt(document.getElementById('newUserDaily').value) || 3;

            if (!userId) {
                showMessage('adminMessage', 'è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ userId, dailyDraws })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', 'ç”¨æˆ·æ·»åŠ æˆåŠŸï¼', 'success');
                    document.getElementById('newUserId').value = '';
                    document.getElementById('newUserDaily').value = '';
                    loadUsers();
                    loadStats();
                } else {
                    showMessage('adminMessage', result.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ ç”¨æˆ·é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // å¢åŠ ç”¨æˆ·æŠ½å¥–æ¬¡æ•°
        async function addUserDraws() {
            const userId = document.getElementById('addDrawsUserId').value.trim();
            const amount = parseInt(document.getElementById('addDrawsAmount').value) || 1;

            if (!userId) {
                showMessage('adminMessage', 'è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/add-draws`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ userId, remainingDraws: amount })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `æˆåŠŸä¸ºç”¨æˆ· ${userId} å¢åŠ  ${amount} æ¬¡æŠ½å¥–æœºä¼šï¼`, 'success');
                    document.getElementById('addDrawsUserId').value = '';
                    document.getElementById('addDrawsAmount').value = '';
                    loadUsers();
                } else {
                    showMessage('adminMessage', result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('å¢åŠ æŠ½å¥–æ¬¡æ•°é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // è®¾ç½®ç”¨æˆ·æ¯æ—¥æŠ½å¥–æ¬¡æ•°
        async function setUserDailyDraws() {
            const userId = document.getElementById('setDailyUserId').value.trim();
            const dailyDraws = parseInt(document.getElementById('setDailyAmount').value) || 3;

            if (!userId) {
                showMessage('adminMessage', 'è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/set-daily-draws`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ userId, dailyDraws })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `æˆåŠŸè®¾ç½®ç”¨æˆ· ${userId} æ¯æ—¥æŠ½å¥–æ¬¡æ•°ä¸º ${dailyDraws} æ¬¡ï¼`, 'success');
                    document.getElementById('setDailyUserId').value = '';
                    document.getElementById('setDailyAmount').value = '';
                    loadUsers();
                } else {
                    showMessage('adminMessage', result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è®¾ç½®æ¯æ—¥æŠ½å¥–æ¬¡æ•°é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${userId}" å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šåˆ é™¤åè¯¥ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®å°†æ— æ³•æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/${encodeURIComponent(userId)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `ç”¨æˆ· ${userId} åˆ é™¤æˆåŠŸï¼`, 'success');
                    loadUsers(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                    loadStats(); // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
                } else {
                    showMessage('adminMessage', result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·å°è¯•è®°å½•
        async function loadAttempts() {
            try {
                const userId = document.getElementById('attemptUserId').value.trim();
                const hours = document.getElementById('attemptHours').value;
                const limit = document.getElementById('attemptLimit').value;
                
                let url = `${API_BASE}/admin/user-attempts?limit=${limit}`;
                if (userId) {
                    url += `&userId=${encodeURIComponent(userId)}`;
                } else if (hours > 0) {
                    url += `&hours=${hours}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tableBody = document.getElementById('attemptsTableBody');
                    if (result.data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">æš‚æ— æ•°æ®</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = result.data.map(attempt => `
                        <tr>
                            <td>${attempt.id}</td>
                            <td><strong>${attempt.attemptUserId}</strong></td>
                            <td>
                                <span class="badge ${attempt.userExists ? 'badge-success' : 'badge-danger'}">
                                    ${attempt.userExists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}
                                </span>
                            </td>
                            <td>${attempt.ipAddress || '-'}</td>
                            <td title="${attempt.userAgent || '-'}" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${attempt.userAgent ? attempt.userAgent.substring(0, 50) + (attempt.userAgent.length > 50 ? '...' : '') : '-'}
                            </td>
                            <td>${new Date(attempt.attemptTime).toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å°è¯•è®°å½•é”™è¯¯:', error);
                showMessage('adminMessage', 'åŠ è½½ç”¨æˆ·å°è¯•è®°å½•å¤±è´¥', 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·å°è¯•ç»Ÿè®¡
        async function loadAttemptStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/user-attempts/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('totalAttempts').textContent = stats.totalAttempts || 0;
                    document.getElementById('existentUserAttempts').textContent = stats.existentUserAttempts || 0;
                    document.getElementById('nonExistentUserAttempts').textContent = stats.nonExistentUserAttempts || 0;
                    document.getElementById('nonExistentRate').textContent = (stats.nonExistentRate || 0).toFixed(1) + '%';
                    
                    // æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸ
                    document.getElementById('attemptStatsSection').style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å°è¯•ç»Ÿè®¡é”™è¯¯:', error);
                showMessage('adminMessage', 'åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // æ¸…ç†æ—§çš„ç”¨æˆ·å°è¯•è®°å½•
        async function cleanupAttempts() {
            const days = document.getElementById('cleanupDays').value;
            
            if (!confirm(`ç¡®å®šè¦æ¸…ç† ${days} å¤©å‰çš„ç”¨æˆ·å°è¯•è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/user-attempts/cleanup?days=${days}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `æ¸…ç†å®Œæˆï¼åˆ é™¤äº† ${result.data.deletedCount} æ¡è®°å½•`, 'success');
                    loadAttempts(); // åˆ·æ–°åˆ—è¡¨
                    loadAttemptStats(); // åˆ·æ–°ç»Ÿè®¡
                } else {
                    showMessage('adminMessage', result.message || 'æ¸…ç†å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ¸…ç†ç”¨æˆ·å°è¯•è®°å½•é”™è¯¯:', error);
                showMessage('adminMessage', 'æ¸…ç†å¤±è´¥', 'error');
            }
        }

        // åŠ è½½æ„¿æœ›åˆ—è¡¨
        async function loadWishes() {
            try {
                const response = await fetch(`${API_BASE}/admin/wishes`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tbody = document.getElementById('wishesTable');
                    tbody.innerHTML = '';

                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">æš‚æ— æ„¿æœ›æ•°æ®</td></tr>';
                        return;
                    }

                    result.data.forEach(wish => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${wish.id}</td>
                            <td><strong>${wish.userId}</strong></td>
                            <td style="max-width: 200px; word-break: break-all; line-height: 1.4;">
                                <span title="${wish.wishContent}">${wish.wishContent}</span>
                            </td>
                            <td>
                                <small>X: ${wish.starX.toFixed(1)}%<br>Y: ${wish.starY.toFixed(1)}%</small>
                            </td>
                            <td>
                                <span class="badge badge-primary">â­ ${wish.starSize}</span>
                            </td>
                            <td>
                                <small>${new Date(wish.createTime).toLocaleString()}</small>
                            </td>
                            <td>
                                <button class="delete-btn" onclick="deleteWish(${wish.id}, '${wish.userId}', '${wish.wishContent.replace(/'/g, "\\'")}')" title="åˆ é™¤æ„¿æœ›">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </td>
                        `;
                    });
                } else {
                    showMessage('adminMessage', result.message || 'åŠ è½½æ„¿æœ›åˆ—è¡¨å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æ„¿æœ›åˆ—è¡¨é”™è¯¯:', error);
                showMessage('adminMessage', 'åŠ è½½æ„¿æœ›åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // åŠ è½½æ„¿æœ›ç»Ÿè®¡ä¿¡æ¯
        async function loadWishStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/wishes/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('totalWishes').textContent = result.data.totalWishes || 0;
                    document.getElementById('wishStatsMessage').textContent = 'âœ¨é—ªè€€ä¸­';
                } else {
                    document.getElementById('totalWishes').textContent = '?';
                    document.getElementById('wishStatsMessage').textContent = 'åŠ è½½å¤±è´¥';
                }
            } catch (error) {
                console.error('åŠ è½½æ„¿æœ›ç»Ÿè®¡é”™è¯¯:', error);
                document.getElementById('totalWishes').textContent = '?';
                document.getElementById('wishStatsMessage').textContent = 'ç½‘ç»œé”™è¯¯';
            }
        }

        // åˆ é™¤æ„¿æœ›
        async function deleteWish(wishId, userId, wishContent) {
            // æˆªæ–­è¿‡é•¿çš„æ„¿æœ›å†…å®¹ç”¨äºæ˜¾ç¤º
            const displayContent = wishContent.length > 20 ? wishContent.substring(0, 20) + '...' : wishContent;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ„¿æœ›å—ï¼Ÿ\n\nç”¨æˆ·ï¼š${userId}\nå†…å®¹ï¼š${displayContent}\n\nâš ï¸ è­¦å‘Šï¼šåˆ é™¤åæ— æ³•æ¢å¤ï¼Œæ˜Ÿç©ºä¸­çš„æ˜Ÿæ˜Ÿä¹Ÿä¼šæ¶ˆå¤±ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/wishes/${wishId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `æ„¿æœ›åˆ é™¤æˆåŠŸï¼ç”¨æˆ· ${userId} çš„æ„¿æœ›å·²ä»æ˜Ÿç©ºä¸­ç§»é™¤ã€‚`, 'success');
                    loadWishes(); // åˆ·æ–°æ„¿æœ›åˆ—è¡¨
                    loadWishStats(); // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
                } else {
                    showMessage('adminMessage', result.message || 'åˆ é™¤æ„¿æœ›å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ„¿æœ›é”™è¯¯:', error);
                showMessage('adminMessage', 'åˆ é™¤æ„¿æœ›å¤±è´¥', 'error');
            }
        }

        // å±…ä½å†å²ç®¡ç†ç›¸å…³å˜é‡
        let residenceCurrentPage = 1;
        let residencePageSize = 20;
        let residenceTotalPages = 0;

        // åŠ è½½å±…ä½å†å²è®°å½•
        async function loadResidenceHistory(page = 1) {
            try {
                residenceCurrentPage = page;
                const response = await fetch(`${API_BASE}/admin/residence-history?page=${page}&size=${residencePageSize}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tbody = document.getElementById('residenceHistoryTable');
                    tbody.innerHTML = '';

                    if (result.data.records.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">æš‚æ— å±…ä½å†å²æ•°æ®</td></tr>';
                        return;
                    }

                    result.data.records.forEach(record => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${record.id}</td>
                            <td><strong>${record.userId}</strong></td>
                            <td>
                                <span class="badge badge-secondary">${getResidenceName(record.previousResidence)}</span>
                            </td>
                            <td>
                                <span class="badge badge-primary">${getResidenceName(record.residence)}</span>
                            </td>
                            <td>
                                <small>${new Date(record.changeTime).toLocaleString()}</small>
                            </td>
                            <td>
                                <small title="${record.userAgent || 'N/A'}">${record.ipAddress || 'N/A'}</small>
                            </td>
                            <td>
                                <button class="delete-btn" onclick="deleteResidenceHistory(${record.id}, '${record.userId}')" title="åˆ é™¤è®°å½•">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </td>
                        `;
                    });

                    // æ›´æ–°åˆ†é¡µä¿¡æ¯
                    residenceTotalPages = result.data.totalPages;
                    document.getElementById('residencePageInfo').textContent = 
                        `ç¬¬ ${page} é¡µï¼Œå…± ${result.data.total} æ¡è®°å½•`;
                    document.getElementById('residenceCurrentPage').textContent = page;
                    
                    // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
                    document.getElementById('residencePrevPage').disabled = page <= 1;
                    document.getElementById('residenceNextPage').disabled = page >= residenceTotalPages;
                } else {
                    showMessage('adminMessage', result.message || 'åŠ è½½å±…ä½å†å²å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å±…ä½å†å²é”™è¯¯:', error);
                showMessage('adminMessage', 'åŠ è½½å±…ä½å†å²å¤±è´¥', 'error');
            }
        }

        // åŠ è½½å±…ä½å†å²ç»Ÿè®¡ä¿¡æ¯
        async function loadResidenceStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/residence-history/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('totalMoves').textContent = result.data.totalMoves || 0;
                    document.getElementById('residenceStatsMessage').textContent = 'ğŸ æ´»è·ƒä¸­';
                } else {
                    document.getElementById('totalMoves').textContent = '?';
                    document.getElementById('residenceStatsMessage').textContent = 'åŠ è½½å¤±è´¥';
                }
            } catch (error) {
                console.error('åŠ è½½å±…ä½å†å²ç»Ÿè®¡é”™è¯¯:', error);
                document.getElementById('totalMoves').textContent = '?';
                document.getElementById('residenceStatsMessage').textContent = 'ç½‘ç»œé”™è¯¯';
            }
        }

        // åˆ é™¤å±…ä½å†å²è®°å½•
        async function deleteResidenceHistory(historyId, userId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${userId} çš„è¿™æ¡å±…ä½å†å²è®°å½•å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šåˆ é™¤åæ— æ³•æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/residence-history/${historyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `å±…ä½å†å²è®°å½•åˆ é™¤æˆåŠŸï¼ç”¨æˆ· ${userId} çš„è®°å½•å·²ç§»é™¤ã€‚`, 'success');
                    loadResidenceHistory(residenceCurrentPage); // åˆ·æ–°å½“å‰é¡µ
                    loadResidenceStats(); // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
                } else {
                    showMessage('adminMessage', result.message || 'åˆ é™¤å±…ä½å†å²è®°å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å±…ä½å†å²è®°å½•é”™è¯¯:', error);
                showMessage('adminMessage', 'åˆ é™¤å±…ä½å†å²è®°å½•å¤±è´¥', 'error');
            }
        }

        // æ”¹å˜å±…ä½å†å²é¡µç 
        function changeResidencePage(direction) {
            const newPage = residenceCurrentPage + direction;
            if (newPage >= 1 && newPage <= residenceTotalPages) {
                loadResidenceHistory(newPage);
            }
        }

        // è·å–å±…ä½åœ°ç‚¹çš„ä¸­æ–‡åç§°
        function getResidenceName(residence) {
            if (!residence) {
                return 'æœªé€‰æ‹©';
            }
            
            const residenceNames = {
                'castle': 'ğŸ° åŸå ¡',
                'city_hall': 'ğŸ›ï¸ å¸‚æ”¿å…',
                'palace': 'ğŸ¯ è¡Œå®«',
                'white_dove_house': 'ğŸ•Šï¸ å°ç™½é¸½å®¶',
                'park': 'ğŸŒ³ å…¬å›­'
            };
            
            return residenceNames[residence] || 'æœªçŸ¥åœ°ç‚¹';
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // 3ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // åŠ è½½å±…æ‰€äº‹ä»¶å†å²æ¦‚è§ˆ
        async function loadResidenceEventOverview() {
            try {
                const response = await fetch(`${API_BASE}/admin/residence-event-history/overview`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const overviewContainer = document.getElementById('residenceOverview');
                    const overview = result.data.overview;
                    
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
                    
                    Object.keys(overview).forEach(residence => {
                        const data = overview[residence];
                        html += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="font-weight: bold; margin-bottom: 8px; color: #333;">
                                    ${data.residenceName}
                                </div>
                                <div style="font-size: 24px; color: #667eea; font-weight: bold; margin-bottom: 5px;">
                                    ${data.totalCount || 0}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    äº‹ä»¶å†å²è®°å½•
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    overviewContainer.innerHTML = html;
                } else {
                    document.getElementById('residenceOverview').innerHTML = 
                        `<div style="text-align: center; padding: 20px; color: #e53e3e;">
                            åŠ è½½å¤±è´¥ï¼š${result.message}
                        </div>`;
                }
            } catch (error) {
                console.error('åŠ è½½å±…æ‰€äº‹ä»¶æ¦‚è§ˆé”™è¯¯:', error);
                document.getElementById('residenceOverview').innerHTML = 
                    `<div style="text-align: center; padding: 20px; color: #e53e3e;">
                        ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•
                    </div>`;
            }
        }

        // æ¸…é™¤å±…æ‰€äº‹ä»¶å†å²
        async function clearResidenceEventHistory() {
            const residence = document.getElementById('clearResidence').value;
            
            if (!residence) {
                showMessage('adminMessage', 'è¯·é€‰æ‹©è¦æ¸…é™¤çš„å±…æ‰€', 'error');
                return;
            }

            // è·å–å±…æ‰€æ˜¾ç¤ºåç§°
            const residenceNames = {
                'castle': 'åŸå ¡ğŸ°',
                'park': 'å…¬å›­ğŸŒ³',
                'city_hall': 'å¸‚æ”¿å…ğŸ›ï¸',
                'white_dove_house': 'å°ç™½é¸½å®¶ğŸ•Šï¸',
                'palace': 'è¡Œå®«ğŸ¯'
            };
            const residenceName = residenceNames[residence] || residence;

            // ç¡®è®¤å¯¹è¯æ¡†
            if (!confirm(`ç¡®å®šè¦æ¸…é™¤ "${residenceName}" çš„æ‰€æœ‰äº‹ä»¶å†å²è®°å½•å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯é€†ï¼Œæ‰€æœ‰å†å²è®°å½•å°†æ°¸ä¹…åˆ é™¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/residence-event-history/${residence}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `${residenceName} çš„äº‹ä»¶å†å²è®°å½•å·²æˆåŠŸæ¸…é™¤ï¼`, 'success');
                    document.getElementById('clearResidence').value = '';
                    // åˆ·æ–°æ¦‚è§ˆæ•°æ®
                    loadResidenceEventOverview();
                } else {
                    showMessage('adminMessage', result.message || 'æ¸…é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ¸…é™¤å±…æ‰€äº‹ä»¶å†å²é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæˆªæ–­æ–‡æœ¬
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // è¾…åŠ©å‡½æ•°ï¼šè½¬ä¹‰HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç¼–è¾‘ç”¨æˆ·ç®€ä»‹
        async function editUserProfile(userId, currentProfile) {
            const newProfile = prompt('ç¼–è¾‘ç”¨æˆ·ç®€ä»‹:', currentProfile || 'è¿™ä¸ªäººå¾ˆç¥ç§˜ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...');
            if (newProfile === null) return; // ç”¨æˆ·å–æ¶ˆ
            
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ profile: newProfile })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `ç”¨æˆ· ${userId} çš„ç®€ä»‹æ›´æ–°æˆåŠŸï¼`, 'success');
                    loadUsers(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                } else {
                    showMessage('adminMessage', result.message || 'æ›´æ–°ç®€ä»‹å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·ç®€ä»‹é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // ç¼–è¾‘ç”¨æˆ·çŠ¶æ€
        async function editUserStatus(userId, currentStatus) {
            const newStatus = prompt('ç¼–è¾‘ç”¨æˆ·çŠ¶æ€:', currentStatus || 'å®‰å±…ä¹ä¸šä¸­');
            if (newStatus === null) return; // ç”¨æˆ·å–æ¶ˆ
            
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `ç”¨æˆ· ${userId} çš„çŠ¶æ€æ›´æ–°æˆåŠŸï¼`, 'success');
                    loadUsers(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                } else {
                    showMessage('adminMessage', result.message || 'æ›´æ–°çŠ¶æ€å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·çŠ¶æ€é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // ==================== é­”æ³•ç®¡ç†åŠŸèƒ½ ====================

        // åŠ è½½é­”æ³•åˆ—è¡¨
        async function loadMagics() {
            try {
                const response = await fetch(`${API_BASE}/admin/magics`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    displayMagics(data.data);
                } else {
                    document.getElementById('magicTable').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e53e3e;">
                            ${data.message || 'åŠ è½½é­”æ³•å¤±è´¥'}
                        </div>`;
                }
            } catch (error) {
                console.error('åŠ è½½é­”æ³•å¤±è´¥:', error);
                document.getElementById('magicTable').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e53e3e;">
                        åŠ è½½é­”æ³•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                    </div>`;
            }
        }

        // æ˜¾ç¤ºé­”æ³•åˆ—è¡¨
        function displayMagics(magics) {
            if (!magics || magics.length === 0) {
                document.getElementById('magicTable').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        æš‚æ— é­”æ³•
                    </div>`;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
            
            magics.forEach(magic => {
                html += `
                    <div style="border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 5px 0; font-size: 18px; color: #2d3748;">
                                    ${magic.name || 'æœªå‘½å'}
                                </h5>
                                <p style="margin: 0; font-size: 12px; color: #a0aec0;">
                                    ä»£ç : ${magic.code}
                                </p>
                            </div>
                            <button class="action-btn" onclick="editMagic('${magic.code}')" style="padding: 8px 16px; font-size: 14px;">
                                âœï¸ ç¼–è¾‘ç²¾åŠ›æ¶ˆè€—
                            </button>
                        </div>
                        <div style="background: #f7fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #667eea;">
                            <p style="margin: 0 0 8px 0; font-size: 14px; color: #4a5568; line-height: 1.6;">
                                ${magic.description || 'æ— æè¿°'}
                            </p>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <div style="background: #FFD700; color: #2d3748; padding: 8px 16px; border-radius: 6px; font-weight: bold;">
                                    âš¡ ç²¾åŠ›æ¶ˆè€—: ${magic.energyCost || 0} ç‚¹
                                </div>
                                <div style="background: #e2e8f0; color: #4a5568; padding: 8px 16px; border-radius: 6px; text-decoration: line-through;">
                                    æ¯æ—¥æ¬¡æ•°é™åˆ¶: å·²ç§»é™¤
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('magicTable').innerHTML = html;
        }

        // ç¼–è¾‘é­”æ³•
        function editMagic(code) {
            fetch(`${API_BASE}/admin/magics`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    const magic = data.data.find(m => m.code === code);
                    if (magic) {
                        showMagicEditDialog(magic);
                    }
                }
            });
        }

        // æ˜¾ç¤ºé­”æ³•ç¼–è¾‘å¯¹è¯æ¡†
        function showMagicEditDialog(magic) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0; color: #2d3748; font-size: 20px;">
                        âœ¨ ç¼–è¾‘é­”æ³•: ${magic.name}
                    </h3>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: bold;">
                            âš¡ ç²¾åŠ›æ¶ˆè€—ï¼ˆç‚¹ï¼‰
                        </label>
                        <input type="number" id="editEnergyCost" value="${magic.energyCost || 0}" min="0" max="100"
                            style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                        <p style="margin: 8px 0 0 0; font-size: 12px; color: #a0aec0;">
                            ç”¨æˆ·æ¯å¤©æœ‰15ç‚¹ç²¾åŠ›ï¼Œæ¯å¤©å‡Œæ™¨12ç‚¹åˆ·æ–°
                        </p>
                    </div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #92400e; line-height: 1.6;">
                            <strong>ğŸ’¡ å»ºè®®é…ç½®ï¼š</strong><br>
                            â€¢ å¤©é™é£Ÿç‰©ï¼š3-5ç‚¹ï¼ˆå¸¸ç”¨åŠŸèƒ½ï¼‰<br>
                            â€¢ æ”¹å˜å¤©æ°”ï¼š2-3ç‚¹ï¼ˆä½æˆæœ¬åŠŸèƒ½ï¼‰<br>
                            â€¢ é©±é€å·¨äººï¼š7-10ç‚¹ï¼ˆé«˜ä»·å€¼åŠŸèƒ½ï¼‰
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()"
                            style="padding: 10px 20px; background: #cbd5e0; color: #2d3748; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            å–æ¶ˆ
                        </button>
                        <button onclick="saveMagicEnergyCost('${magic.code}')"
                            style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold;">
                            ğŸ’¾ ä¿å­˜
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ä¿å­˜é­”æ³•ç²¾åŠ›æ¶ˆè€—
        async function saveMagicEnergyCost(code) {
            const energyCost = parseInt(document.getElementById('editEnergyCost').value);

            if (isNaN(energyCost) || energyCost < 0) {
                alert('ç²¾åŠ›æ¶ˆè€—å¿…é¡»æ˜¯å¤§äºç­‰äº0çš„æ•°å­—');
                return;
            }

            if (energyCost > 100) {
                alert('ç²¾åŠ›æ¶ˆè€—ä¸èƒ½è¶…è¿‡100ç‚¹');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/magics/${code}/energy-cost`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ energyCost })
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ç²¾åŠ›æ¶ˆè€—æ›´æ–°æˆåŠŸ');
                    document.querySelector('div[style*="position: fixed"]').remove();
                    loadMagics();
                } else {
                    alert('âŒ æ›´æ–°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ==================== å·¨äººè¿›æ”»ç®¡ç†åŠŸèƒ½ ====================

        // åŠ è½½å·¨äººè¿›æ”»çŠ¶æ€
        async function loadGiantAttackStatus() {
            try {
                const response = await fetch(`${API_BASE}/giant-attack/status`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    document.getElementById('giantAttackStatus').textContent = data.isAttacking ? 'ğŸ‘¹ æ­£åœ¨è¿›æ”»' : 'ğŸ›¡ï¸ æœªè¿›æ”»';
                    document.getElementById('giantAttackStatus').style.color = data.isAttacking ? '#e53e3e' : '#48bb78';
                    
                    if (data.isAttacking && data.startTime) {
                        const startTime = new Date(data.startTime).toLocaleString();
                        document.getElementById('giantAttackTime').textContent = startTime;
                    } else {
                        document.getElementById('giantAttackTime').textContent = '-';
                    }
                    
                    // åŠ è½½å†å²è®°å½•
                    loadGiantAttackHistory();
                } else {
                    showMessage('adminMessage', result.message || 'åŠ è½½å·¨äººè¿›æ”»çŠ¶æ€å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å·¨äººè¿›æ”»çŠ¶æ€é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // è§¦å‘å·¨äººè¿›æ”»
        async function triggerGiantAttack() {
            if (!confirm('ç¡®å®šè¦è§¦å‘å·¨äººè¿›æ”»å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šå·¨äººè¿›æ”»å°†å¼€å§‹å¯¹æ˜Ÿæ˜ŸåŸé€ æˆæŒç»­ä¼¤å®³ï¼')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/giant-attack/trigger`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', 'ğŸ‘¹ å·¨äººè¿›æ”»å·²è§¦å‘ï¼', 'success');
                    loadGiantAttackStatus(); // åˆ·æ–°çŠ¶æ€
                } else {
                    showMessage('adminMessage', result.message || 'è§¦å‘å·¨äººè¿›æ”»å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è§¦å‘å·¨äººè¿›æ”»é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // ç»“æŸå·¨äººè¿›æ”»
        async function endGiantAttack() {
            if (!confirm('ç¡®å®šè¦ç»“æŸå·¨äººè¿›æ”»å—ï¼Ÿ\n\nå·¨äººå°†åœæ­¢å¯¹æ˜Ÿæ˜ŸåŸçš„ä¼¤å®³ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/giant-attack/end`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', 'ğŸ›¡ï¸ å·¨äººè¿›æ”»å·²ç»“æŸï¼', 'success');
                    loadGiantAttackStatus(); // åˆ·æ–°çŠ¶æ€
                } else {
                    showMessage('adminMessage', result.message || 'ç»“æŸå·¨äººè¿›æ”»å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç»“æŸå·¨äººè¿›æ”»é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // å¤„ç†å·¨äººä¼¤å®³
        async function processGiantDamage() {
            if (!confirm('ç¡®å®šè¦æ‰‹åŠ¨å¤„ç†å·¨äººä¼¤å®³å—ï¼Ÿ\n\nè¿™å°†ç«‹å³å¯¹æ˜Ÿæ˜ŸåŸé€ æˆä¸€æ¬¡ä¼¤å®³ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/giant-attack/damage`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', 'âš”ï¸ å·¨äººä¼¤å®³å·²å¤„ç†ï¼', 'success');
                    loadGiantAttackStatus(); // åˆ·æ–°çŠ¶æ€
                } else {
                    showMessage('adminMessage', result.message || 'å¤„ç†å·¨äººä¼¤å®³å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('å¤„ç†å·¨äººä¼¤å®³é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // åŠ è½½å·¨äººè¿›æ”»å†å²
        async function loadGiantAttackHistory() {
            try {
                const response = await fetch(`${API_BASE}/giant-attack/admin/history`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tbody = document.getElementById('giantAttackHistoryTable');
                    tbody.innerHTML = '';

                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">æš‚æ— å·¨äººè¿›æ”»å†å²</td></tr>';
                        return;
                    }

                    result.data.forEach(attack => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${attack.id}</td>
                            <td>
                                <span class="badge ${attack.isActive ? 'badge-danger' : 'badge-secondary'}">
                                    ${attack.isActive ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}
                                </span>
                            </td>
                            <td>${attack.startTime ? new Date(attack.startTime).toLocaleString() : '-'}</td>
                            <td>${attack.endTime ? new Date(attack.endTime).toLocaleString() : '-'}</td>
                            <td>${attack.lastDamageTime ? new Date(attack.lastDamageTime).toLocaleString() : '-'}</td>
                            <td>${new Date(attack.createTime).toLocaleString()}</td>
                        `;
                    });
                } else {
                    showMessage('adminMessage', result.message || 'åŠ è½½å·¨äººè¿›æ”»å†å²å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å·¨äººè¿›æ”»å†å²é”™è¯¯:', error);
                showMessage('adminMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
    </script>
</body>
</html>
