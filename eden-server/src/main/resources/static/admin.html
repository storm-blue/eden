<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé™ EdenÊäΩÂ•ñÁ≥ªÁªü - ÁÆ°ÁêÜÂêéÂè∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* ÁôªÂΩïË°®ÂçïÊ†∑Âºè */
        .login-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
        }

        .login-title {
            text-align: center;
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        /* ÁÆ°ÁêÜÁïåÈù¢Ê†∑Âºè */
        .admin-panel {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .admin-header h2 {
            color: #333;
            font-size: 24px;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .action-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .action-form h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .filter-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .stats-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .stats-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }

        .badge-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }

        .form-field {
            flex: 1;
        }

        .form-field label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        .form-field input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .action-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #5a67d8;
        }

        .delete-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #c53030;
            transform: translateY(-1px);
        }

        .delete-btn:active {
            transform: translateY(0);
        }

        .message {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé™ EdenÊäΩÂ•ñÁ≥ªÁªü</h1>
            <p>ÁÆ°ÁêÜÂêéÂè∞ÊéßÂà∂Èù¢Êùø</p>
        </div>

        <!-- ÁôªÂΩïË°®Âçï -->
        <div id="loginContainer" class="login-container">
            <h2 class="login-title">ÁÆ°ÁêÜÂëòÁôªÂΩï</h2>
            <div id="loginMessage"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Áî®Êà∑Âêç</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">ÂØÜÁ†Å</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">ÁôªÂΩï</button>
            </form>
        </div>

        <!-- ÁÆ°ÁêÜÈù¢Êùø -->
        <div id="adminPanel" class="admin-panel">
            <div class="admin-header">
                <h2>ÁÆ°ÁêÜÊéßÂà∂Èù¢Êùø</h2>
                <button id="logoutBtn" class="logout-btn">ÈÄÄÂá∫ÁôªÂΩï</button>
            </div>

            <div id="adminMessage"></div>

            <!-- ÁªüËÆ°‰ø°ÊÅØ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalUsers">-</h3>
                    <p>ÊÄªÁî®Êà∑Êï∞</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeUsers">-</h3>
                    <p>Ê¥ªË∑ÉÁî®Êà∑</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalDraws">-</h3>
                    <p>ÊÄªÊäΩÂ•ñÊ¨°Êï∞</p>
                </div>
            </div>

            <!-- Ê†áÁ≠æÈ°µÂØºËà™ -->
            <div class="tabs">
                <button class="tab active" data-tab="users">Áî®Êà∑ÁÆ°ÁêÜ</button>
                <button class="tab" data-tab="history">ÊäΩÂ•ñÂéÜÂè≤</button>
                <button class="tab" data-tab="attempts">Áî®Êà∑Â∞ùËØïËÆ∞ÂΩï</button>
                <button class="tab" data-tab="actions">Áî®Êà∑Êìç‰Ωú</button>
            </div>

            <!-- Áî®Êà∑ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
            <div id="users" class="tab-content active">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Áî®Êà∑ID</th>
                            <th>Ââ©‰ΩôÊ¨°Êï∞</th>
                            <th>ÊØèÊó•Ê¨°Êï∞</th>
                            <th>ÂàõÂª∫Êó∂Èó¥</th>
                            <th>ÊúÄÂêéÂà∑Êñ∞</th>
                            <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr><td colspan="6" style="text-align: center; padding: 20px;">Âä†ËΩΩ‰∏≠...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ÊäΩÂ•ñÂéÜÂè≤Ê†áÁ≠æÈ°µ -->
            <div id="history" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Áî®Êà∑ID</th>
                                <th>Â•ñÂìÅ</th>
                                <th>Á≠âÁ∫ß</th>
                                <th>IPÂú∞ÂùÄ</th>
                                <th>ÊäΩÂ•ñÊó∂Èó¥</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <tr><td colspan="6" style="text-align: center; padding: 20px;">ÁÇπÂáªÂà∑Êñ∞Âä†ËΩΩÊï∞ÊçÆ</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Áî®Êà∑Â∞ùËØïËÆ∞ÂΩïÊ†áÁ≠æÈ°µ -->
            <div id="attempts" class="tab-content">
                <!-- ËøáÊª§ÈÄâÈ°π -->
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="attemptUserId">Áî®Êà∑IDÁ≠õÈÄâ:</label>
                            <input type="text" id="attemptUserId" placeholder="ËæìÂÖ•Áî®Êà∑IDËøõË°åÁ≠õÈÄâ">
                        </div>
                        <div class="form-group">
                            <label for="attemptHours">Êó∂Èó¥ËåÉÂõ¥:</label>
                            <select id="attemptHours">
                                <option value="1">ÊúÄËøë1Â∞èÊó∂</option>
                                <option value="6">ÊúÄËøë6Â∞èÊó∂</option>
                                <option value="24" selected>ÊúÄËøë24Â∞èÊó∂</option>
                                <option value="72">ÊúÄËøë3Â§©</option>
                                <option value="168">ÊúÄËøë7Â§©</option>
                                <option value="0">ÂÖ®ÈÉ®ËÆ∞ÂΩï</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="attemptLimit">ÊòæÁ§∫Êù°Êï∞:</label>
                            <select id="attemptLimit">
                                <option value="50">50Êù°</option>
                                <option value="100" selected>100Êù°</option>
                                <option value="200">200Êù°</option>
                                <option value="500">500Êù°</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button onclick="loadAttempts()" class="btn btn-primary">üîç Êü•ËØ¢</button>
                            <button onclick="loadAttemptStats()" class="btn btn-secondary">üìä ÁªüËÆ°</button>
                        </div>
                    </div>
                </div>

                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div id="attemptStatsSection" class="stats-section" style="display: none;">
                    <h4>üìä Áî®Êà∑Â∞ùËØïÁªüËÆ°</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalAttempts">-</h3>
                            <p>ÊÄªÂ∞ùËØïÊ¨°Êï∞</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="existentUserAttempts">-</h3>
                            <p>Â∑≤Â≠òÂú®Áî®Êà∑Â∞ùËØï</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="nonExistentUserAttempts">-</h3>
                            <p>‰∏çÂ≠òÂú®Áî®Êà∑Â∞ùËØï</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="nonExistentRate">-</h3>
                            <p>‰∏çÂ≠òÂú®Áî®Êà∑ÊØî‰æã</p>
                        </div>
                    </div>
                </div>

                <!-- Â∞ùËØïËÆ∞ÂΩïË°®Ê†º -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Áî®Êà∑ID</th>
                                <th>Áî®Êà∑Â≠òÂú®</th>
                                <th>IPÂú∞ÂùÄ</th>
                                <th>Áî®Êà∑‰ª£ÁêÜ</th>
                                <th>Â∞ùËØïÊó∂Èó¥</th>
                            </tr>
                        </thead>
                        <tbody id="attemptsTableBody">
                            <!-- Âä®ÊÄÅÂä†ËΩΩ -->
                        </tbody>
                    </table>
                </div>

                <!-- Ê∏ÖÁêÜÊìç‰Ωú -->
                <div class="action-form">
                    <h4>üóëÔ∏è Ê∏ÖÁêÜÊóßËÆ∞ÂΩï</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cleanupDays">Ê∏ÖÁêÜÂ§©Êï∞:</label>
                            <select id="cleanupDays">
                                <option value="7">7Â§©Ââç</option>
                                <option value="30" selected>30Â§©Ââç</option>
                                <option value="90">90Â§©Ââç</option>
                                <option value="365">1Âπ¥Ââç</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button onclick="cleanupAttempts()" class="btn btn-danger">üóëÔ∏è Ê∏ÖÁêÜËÆ∞ÂΩï</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Áî®Êà∑Êìç‰ΩúÊ†áÁ≠æÈ°µ -->
            <div id="actions" class="tab-content">
                <!-- Ê∑ªÂä†Áî®Êà∑ -->
                <div class="action-form">
                    <h4>üìù Ê∑ªÂä†Êñ∞Áî®Êà∑</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="newUserId">Áî®Êà∑IDÔºàÂßìÂêçÔºâ</label>
                            <input type="text" id="newUserId" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂßìÂêç">
                        </div>
                        <div class="form-field">
                            <label for="newUserDaily">ÊØèÊó•ÊäΩÂ•ñÊ¨°Êï∞</label>
                            <input type="number" id="newUserDaily" placeholder="ÈªòËÆ§3Ê¨°" min="1" max="10">
                        </div>
                        <button class="action-btn" onclick="addUser()">Ê∑ªÂä†Áî®Êà∑</button>
                    </div>
                </div>

                <!-- Â¢ûÂä†ÊäΩÂ•ñÊ¨°Êï∞ -->
                <div class="action-form">
                    <h4>üéØ Â¢ûÂä†Áî®Êà∑ÊäΩÂ•ñÊ¨°Êï∞</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="addDrawsUserId">Áî®Êà∑ID</label>
                            <input type="text" id="addDrawsUserId" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂßìÂêç">
                        </div>
                        <div class="form-field">
                            <label for="addDrawsAmount">Â¢ûÂä†Ê¨°Êï∞</label>
                            <input type="number" id="addDrawsAmount" placeholder="1" min="1" max="100">
                        </div>
                        <button class="action-btn" onclick="addUserDraws()">Â¢ûÂä†Ê¨°Êï∞</button>
                    </div>
                </div>

                <!-- ËÆæÁΩÆÊØèÊó•Ê¨°Êï∞ -->
                <div class="action-form">
                    <h4>‚öôÔ∏è ËÆæÁΩÆÁî®Êà∑ÊØèÊó•ÊäΩÂ•ñÊ¨°Êï∞</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="setDailyUserId">Áî®Êà∑ID</label>
                            <input type="text" id="setDailyUserId" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂßìÂêç">
                        </div>
                        <div class="form-field">
                            <label for="setDailyAmount">ÊØèÊó•Ê¨°Êï∞</label>
                            <input type="number" id="setDailyAmount" placeholder="3" min="1" max="10">
                        </div>
                        <button class="action-btn" onclick="setUserDailyDraws()">ËÆæÁΩÆÊ¨°Êï∞</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let adminToken = null;

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // Ê£ÄÊü•Êú¨Âú∞Â≠òÂÇ®ÁöÑtoken
            adminToken = localStorage.getItem('adminToken');
            if (adminToken) {
                validateTokenAndShowAdmin();
            }

            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Ê†áÁ≠æÈ°µÂàáÊç¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
        });

        // Â§ÑÁêÜÁôªÂΩï
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (result.success) {
                    adminToken = result.data.token;
                    localStorage.setItem('adminToken', adminToken);
                    showMessage('loginMessage', 'ÁôªÂΩïÊàêÂäüÔºÅ', 'success');
                    setTimeout(() => {
                        showAdminPanel();
                    }, 1000);
                } else {
                    showMessage('loginMessage', result.message || 'ÁôªÂΩïÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('ÁôªÂΩïÈîôËØØ:', error);
                showMessage('loginMessage', 'ÁΩëÁªúËøûÊé•Â§±Ë¥•', 'error');
            }
        }

        // È™åËØÅtokenÂπ∂ÊòæÁ§∫ÁÆ°ÁêÜÈù¢Êùø
        async function validateTokenAndShowAdmin() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    showAdminPanel();
                } else {
                    // TokenÊó†ÊïàÔºåÊ∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®
                    localStorage.removeItem('adminToken');
                    adminToken = null;
                }
            } catch (error) {
                console.error('TokenÈ™åËØÅÈîôËØØ:', error);
                localStorage.removeItem('adminToken');
                adminToken = null;
            }
        }

        // ÊòæÁ§∫ÁÆ°ÁêÜÈù¢Êùø
        function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadStats();
            loadUsers();
        }

        // Â§ÑÁêÜÁôªÂá∫
        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/admin/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
            } catch (error) {
                console.error('ÁôªÂá∫ÈîôËØØ:', error);
            }

            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // ÂàáÊç¢Ê†áÁ≠æÈ°µ
        function switchTab(tabName) {
            // Êõ¥Êñ∞Ê†áÁ≠æÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });

            // Êõ¥Êñ∞ÂÜÖÂÆπÊòæÁ§∫
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Âä†ËΩΩÂØπÂ∫îÊï∞ÊçÆ
            if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'attempts') {
                loadAttempts();
            }
        }

        // Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØ
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('totalUsers').textContent = result.data.totalUsers;
                    document.getElementById('activeUsers').textContent = result.data.totalActiveUsers;
                    document.getElementById('totalDraws').textContent = result.data.lotteryStats.totalDraws;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØÈîôËØØ:', error);
            }
        }

        // Âä†ËΩΩÁî®Êà∑ÂàóË°®
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tbody = document.getElementById('usersTable');
                    tbody.innerHTML = '';

                    result.data.forEach(user => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${user.userId}</td>
                            <td>${user.remainingDraws}</td>
                            <td>${user.dailyDraws}</td>
                            <td>${new Date(user.createTime).toLocaleString()}</td>
                            <td>${new Date(user.lastRefreshDate).toLocaleString()}</td>
                            <td>
                                <button class="delete-btn" onclick="deleteUser('${user.userId}')" title="Âà†Èô§Áî®Êà∑">
                                    üóëÔ∏è Âà†Èô§
                                </button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑ÂàóË°®ÈîôËØØ:', error);
            }
        }

        // Âä†ËΩΩÊäΩÂ•ñÂéÜÂè≤
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/admin/lottery-history`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tbody = document.getElementById('historyTable');
                    tbody.innerHTML = '';

                    result.data.forEach(record => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${record.id}</td>
                            <td>${record.userId}</td>
                            <td>${record.prizeName}</td>
                            <td>${record.prizeLevel}</td>
                            <td>${record.ipAddress}</td>
                            <td>${new Date(record.createTime).toLocaleString()}</td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊäΩÂ•ñÂéÜÂè≤ÈîôËØØ:', error);
            }
        }

        // Ê∑ªÂä†Áî®Êà∑
        async function addUser() {
            const userId = document.getElementById('newUserId').value.trim();
            const dailyDraws = parseInt(document.getElementById('newUserDaily').value) || 3;

            if (!userId) {
                showMessage('adminMessage', 'ËØ∑ËæìÂÖ•Áî®Êà∑ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ userId, dailyDraws })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', 'Áî®Êà∑Ê∑ªÂä†ÊàêÂäüÔºÅ', 'success');
                    document.getElementById('newUserId').value = '';
                    document.getElementById('newUserDaily').value = '';
                    loadUsers();
                    loadStats();
                } else {
                    showMessage('adminMessage', result.message || 'Ê∑ªÂä†Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ê∑ªÂä†Áî®Êà∑ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // Â¢ûÂä†Áî®Êà∑ÊäΩÂ•ñÊ¨°Êï∞
        async function addUserDraws() {
            const userId = document.getElementById('addDrawsUserId').value.trim();
            const amount = parseInt(document.getElementById('addDrawsAmount').value) || 1;

            if (!userId) {
                showMessage('adminMessage', 'ËØ∑ËæìÂÖ•Áî®Êà∑ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/add-draws`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ userId, remainingDraws: amount })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `ÊàêÂäü‰∏∫Áî®Êà∑ ${userId} Â¢ûÂä† ${amount} Ê¨°ÊäΩÂ•ñÊú∫‰ºöÔºÅ`, 'success');
                    document.getElementById('addDrawsUserId').value = '';
                    document.getElementById('addDrawsAmount').value = '';
                    loadUsers();
                } else {
                    showMessage('adminMessage', result.message || 'Êìç‰ΩúÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Â¢ûÂä†ÊäΩÂ•ñÊ¨°Êï∞ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // ËÆæÁΩÆÁî®Êà∑ÊØèÊó•ÊäΩÂ•ñÊ¨°Êï∞
        async function setUserDailyDraws() {
            const userId = document.getElementById('setDailyUserId').value.trim();
            const dailyDraws = parseInt(document.getElementById('setDailyAmount').value) || 3;

            if (!userId) {
                showMessage('adminMessage', 'ËØ∑ËæìÂÖ•Áî®Êà∑ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/set-daily-draws`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ userId, dailyDraws })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `ÊàêÂäüËÆæÁΩÆÁî®Êà∑ ${userId} ÊØèÊó•ÊäΩÂ•ñÊ¨°Êï∞‰∏∫ ${dailyDraws} Ê¨°ÔºÅ`, 'success');
                    document.getElementById('setDailyUserId').value = '';
                    document.getElementById('setDailyAmount').value = '';
                    loadUsers();
                } else {
                    showMessage('adminMessage', result.message || 'Êìç‰ΩúÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('ËÆæÁΩÆÊØèÊó•ÊäΩÂ•ñÊ¨°Êï∞ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // Âà†Èô§Áî®Êà∑
        async function deleteUser(userId) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Áî®Êà∑ "${userId}" ÂêóÔºü\n\n‚ö†Ô∏è Ë≠¶ÂëäÔºöÂà†Èô§ÂêéËØ•Áî®Êà∑ÁöÑÊâÄÊúâÊï∞ÊçÆÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºÅ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/${encodeURIComponent(userId)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `Áî®Êà∑ ${userId} Âà†Èô§ÊàêÂäüÔºÅ`, 'success');
                    loadUsers(); // Âà∑Êñ∞Áî®Êà∑ÂàóË°®
                    loadStats(); // Âà∑Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                } else {
                    showMessage('adminMessage', result.message || 'Âà†Èô§Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âà†Èô§Áî®Êà∑ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // Âä†ËΩΩÁî®Êà∑Â∞ùËØïËÆ∞ÂΩï
        async function loadAttempts() {
            try {
                const userId = document.getElementById('attemptUserId').value.trim();
                const hours = document.getElementById('attemptHours').value;
                const limit = document.getElementById('attemptLimit').value;
                
                let url = `${API_BASE}/admin/user-attempts?limit=${limit}`;
                if (userId) {
                    url += `&userId=${encodeURIComponent(userId)}`;
                } else if (hours > 0) {
                    url += `&hours=${hours}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tableBody = document.getElementById('attemptsTableBody');
                    if (result.data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = result.data.map(attempt => `
                        <tr>
                            <td>${attempt.id}</td>
                            <td><strong>${attempt.attemptUserId}</strong></td>
                            <td>
                                <span class="badge ${attempt.userExists ? 'badge-success' : 'badge-danger'}">
                                    ${attempt.userExists ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}
                                </span>
                            </td>
                            <td>${attempt.ipAddress || '-'}</td>
                            <td title="${attempt.userAgent || '-'}" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${attempt.userAgent ? attempt.userAgent.substring(0, 50) + (attempt.userAgent.length > 50 ? '...' : '') : '-'}
                            </td>
                            <td>${new Date(attempt.attemptTime).toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑Â∞ùËØïËÆ∞ÂΩïÈîôËØØ:', error);
                showMessage('adminMessage', 'Âä†ËΩΩÁî®Êà∑Â∞ùËØïËÆ∞ÂΩïÂ§±Ë¥•', 'error');
            }
        }

        // Âä†ËΩΩÁî®Êà∑Â∞ùËØïÁªüËÆ°
        async function loadAttemptStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/user-attempts/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('totalAttempts').textContent = stats.totalAttempts || 0;
                    document.getElementById('existentUserAttempts').textContent = stats.existentUserAttempts || 0;
                    document.getElementById('nonExistentUserAttempts').textContent = stats.nonExistentUserAttempts || 0;
                    document.getElementById('nonExistentRate').textContent = (stats.nonExistentRate || 0).toFixed(1) + '%';
                    
                    // ÊòæÁ§∫ÁªüËÆ°Âå∫Âüü
                    document.getElementById('attemptStatsSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑Â∞ùËØïÁªüËÆ°ÈîôËØØ:', error);
                showMessage('adminMessage', 'Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•', 'error');
            }
        }

        // Ê∏ÖÁêÜÊóßÁöÑÁî®Êà∑Â∞ùËØïËÆ∞ÂΩï
        async function cleanupAttempts() {
            const days = document.getElementById('cleanupDays').value;
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜ ${days} Â§©ÂâçÁöÑÁî®Êà∑Â∞ùËØïËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/user-attempts/cleanup?days=${days}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `Ê∏ÖÁêÜÂÆåÊàêÔºÅÂà†Èô§‰∫Ü ${result.data.deletedCount} Êù°ËÆ∞ÂΩï`, 'success');
                    loadAttempts(); // Âà∑Êñ∞ÂàóË°®
                    loadAttemptStats(); // Âà∑Êñ∞ÁªüËÆ°
                } else {
                    showMessage('adminMessage', result.message || 'Ê∏ÖÁêÜÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ê∏ÖÁêÜÁî®Êà∑Â∞ùËØïËÆ∞ÂΩïÈîôËØØ:', error);
                showMessage('adminMessage', 'Ê∏ÖÁêÜÂ§±Ë¥•', 'error');
            }
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // 3ÁßíÂêéËá™Âä®Ê∏ÖÈô§Ê∂àÊÅØ
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }
    </script>
</body>
</html>
