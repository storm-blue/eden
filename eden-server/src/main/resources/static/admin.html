<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé™ EdenÊäΩÂ•ñÁ≥ªÁªü - ÁÆ°ÁêÜÂêéÂè∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* ÁôªÂΩïË°®ÂçïÊ†∑Âºè */
        .login-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
        }

        .login-title {
            text-align: center;
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        /* ÁÆ°ÁêÜÁïåÈù¢Ê†∑Âºè */
        .admin-panel {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .admin-header h2 {
            color: #333;
            font-size: 24px;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .action-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .action-form h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .filter-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .stats-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .stats-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }

        .badge-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .badge-secondary {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        .badge-primary {
            background-color: #bee5eb;
            color: #0c5460;
            border: 1px solid #abdde5;
        }

        .badge-warning {
            background-color: #ffeaa7;
            color: #856404;
            border: 1px solid #ffd93d;
        }

        /* ÂàÜÈ°µÊ†∑Âºè */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-controls .btn {
            padding: 6px 12px;
            font-size: 14px;
            min-width: 60px;
        }

        .pagination-controls .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
            margin: 0 10px;
        }

        .page-number {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 32px;
            text-align: center;
        }

        .page-number:hover {
            background: #e9ecef;
        }

        .page-number.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }

        .form-field {
            flex: 1;
        }

        .form-field label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        .form-field input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .action-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #5a67d8;
        }

        .delete-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #c53030;
            transform: translateY(-1px);
        }

        .delete-btn:active {
            transform: translateY(0);
        }

        .message {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .tabs {
                flex-wrap: wrap;
            }

        .tab {
            flex: 1;
            min-width: 120px;
        }

        /* Áî®Êà∑ÁÆÄ‰ªãÂíåÁä∂ÊÄÅÁºñËæëÊ†∑Âºè */
        .profile-cell, .status-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 200px;
        }

        .profile-text, .status-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .edit-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            min-width: 30px;
            transition: background-color 0.3s;
        }

        .edit-btn:hover {
            background: #45a049;
        }

        .profile-text {
            color: #666;
            font-style: italic;
        }

        .status-text {
            color: #2196F3;
            font-weight: 500;
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé™ EdenÊäΩÂ•ñÁ≥ªÁªü</h1>
            <p>ÁÆ°ÁêÜÂêéÂè∞ÊéßÂà∂Èù¢Êùø</p>
        </div>

        <!-- ÁôªÂΩïË°®Âçï -->
        <div id="loginContainer" class="login-container">
            <h2 class="login-title">ÁÆ°ÁêÜÂëòÁôªÂΩï</h2>
            <div id="loginMessage"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Áî®Êà∑Âêç</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">ÂØÜÁ†Å</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">ÁôªÂΩï</button>
            </form>
        </div>

        <!-- ÁÆ°ÁêÜÈù¢Êùø -->
        <div id="adminPanel" class="admin-panel">
            <div class="admin-header">
                <h2>ÁÆ°ÁêÜÊéßÂà∂Èù¢Êùø</h2>
                <button id="logoutBtn" class="logout-btn">ÈÄÄÂá∫ÁôªÂΩï</button>
            </div>

            <div id="adminMessage"></div>

            <!-- ÁªüËÆ°‰ø°ÊÅØ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalUsers">-</h3>
                    <p>ÊÄªÁî®Êà∑Êï∞</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeUsers">-</h3>
                    <p>Ê¥ªË∑ÉÁî®Êà∑</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalDraws">-</h3>
                    <p>ÊÄªÊäΩÂ•ñÊ¨°Êï∞</p>
                </div>
            </div>

            <!-- Ê†áÁ≠æÈ°µÂØºËà™ -->
            <div class="tabs">
                <button class="tab active" data-tab="users">Áî®Êà∑ÁÆ°ÁêÜ</button>
                <button class="tab" data-tab="history">ÊäΩÂ•ñÂéÜÂè≤</button>
                <button class="tab" data-tab="wishes">ÊÑøÊúõÁÆ°ÁêÜ</button>
                <button class="tab" data-tab="residence">Â±Ö‰ΩèÂéÜÂè≤</button>
                <button class="tab" data-tab="attempts">Áî®Êà∑Â∞ùËØïËÆ∞ÂΩï</button>
                <button class="tab" data-tab="actions">Áî®Êà∑Êìç‰Ωú</button>
                <button class="tab" data-tab="residence-events">Â±ÖÊâÄ‰∫ã‰ª∂</button>
                <button class="tab" data-tab="decrees">ÂëΩ‰ª§ÁÆ°ÁêÜ</button>
                <button class="tab" data-tab="magic">È≠îÊ≥ïÁÆ°ÁêÜ</button>
                <button class="tab" data-tab="giant-attack">Â∑®‰∫∫ËøõÊîªÁÆ°ÁêÜ</button>
            </div>

            <!-- Áî®Êà∑ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
            <div id="users" class="tab-content active">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Áî®Êà∑ID</th>
                                <th>Ââ©‰ΩôÊ¨°Êï∞</th>
                                <th>ÊØèÊó•Ê¨°Êï∞</th>
                                <th>ÁÆÄ‰ªã</th>
                                <th>Áä∂ÊÄÅ</th>
                                <th>ÂàõÂª∫Êó∂Èó¥</th>
                                <th>ÊúÄÂêéÂà∑Êñ∞</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr><td colspan="8" style="text-align: center; padding: 20px;">Âä†ËΩΩ‰∏≠...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ÊäΩÂ•ñÂéÜÂè≤Ê†áÁ≠æÈ°µ -->
            <div id="history" class="tab-content">
                <!-- Á≠õÈÄâÂíåÂàÜÈ°µÊéßÂà∂ -->
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyUserId">Áî®Êà∑IDÁ≠õÈÄâ:</label>
                            <input type="text" id="historyUserId" placeholder="ËæìÂÖ•Áî®Êà∑IDËøõË°åÁ≠õÈÄâ">
                        </div>
                        <div class="form-group">
                            <label for="historyPageSize">ÊØèÈ°µÊù°Êï∞:</label>
                            <select id="historyPageSize">
                                <option value="10">10Êù°</option>
                                <option value="20" selected>20Êù°</option>
                                <option value="50">50Êù°</option>
                                <option value="100">100Êù°</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button onclick="loadHistory(1)" class="btn btn-primary">üîç Êü•ËØ¢</button>
                            <button onclick="clearHistoryFilter()" class="btn btn-secondary">üîÑ Ê∏ÖÈô§Á≠õÈÄâ</button>
                        </div>
                    </div>
                </div>

                <!-- Êï∞ÊçÆË°®Ê†º -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Áî®Êà∑ID</th>
                                <th>Â•ñÂìÅ</th>
                                <th>Á≠âÁ∫ß</th>
                                <th>IPÂú∞ÂùÄ</th>
                                <th>ÊäΩÂ•ñÊó∂Èó¥</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <tr><td colspan="6" style="text-align: center; padding: 20px;">ÁÇπÂáªÊü•ËØ¢Âä†ËΩΩÊï∞ÊçÆ</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- ÂàÜÈ°µÂØºËà™ -->
                <div class="pagination-container" id="historyPagination" style="display: none;">
                    <div class="pagination-info">
                        <span id="historyPaginationInfo">ÊòæÁ§∫Á¨¨ 1-20 Êù°ÔºåÂÖ± 0 Êù°ËÆ∞ÂΩï</span>
                    </div>
                    <div class="pagination-controls">
                        <button id="historyFirstPage" onclick="loadHistory(1)" class="btn btn-sm">È¶ñÈ°µ</button>
                        <button id="historyPrevPage" onclick="loadHistoryPrevPage()" class="btn btn-sm">‰∏ä‰∏ÄÈ°µ</button>
                        <span class="page-numbers" id="historyPageNumbers"></span>
                        <button id="historyNextPage" onclick="loadHistoryNextPage()" class="btn btn-sm">‰∏ã‰∏ÄÈ°µ</button>
                        <button id="historyLastPage" onclick="loadHistoryLastPage()" class="btn btn-sm">Êú´È°µ</button>
                    </div>
                </div>
            </div>

            <!-- ÊÑøÊúõÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
            <div id="wishes" class="tab-content">
                <!-- ÊÑøÊúõÁªüËÆ°‰ø°ÊÅØ -->
                <div class="stats-section">
                    <h4>‚ú® ÊÑøÊúõÁªüËÆ°</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalWishes">-</h3>
                            <p>ÊÄªÊÑøÊúõÊï∞</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="wishStatsMessage">-</h3>
                            <p>ÊòüÁ©∫Áä∂ÊÄÅ</p>
                        </div>
                    </div>
                </div>

                <!-- ÊÑøÊúõÂàóË°® -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Áî®Êà∑ID</th>
                                <th>ÊÑøÊúõÂÜÖÂÆπ</th>
                                <th>ÊòüÊòü‰ΩçÁΩÆ</th>
                                <th>ÊòüÊòüÂ§ßÂ∞è</th>
                                <th>ÂàõÂª∫Êó∂Èó¥</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="wishesTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">ÁÇπÂáªÂä†ËΩΩÊÑøÊúõÊï∞ÊçÆ</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Âä†ËΩΩÊåâÈíÆ -->
                <div class="action-form">
                    <div class="form-row">
                        <button onclick="loadWishes()" class="action-btn">üîÑ Âà∑Êñ∞ÊÑøÊúõÂàóË°®</button>
                        <button onclick="loadWishStats()" class="action-btn">üìä Êõ¥Êñ∞ÁªüËÆ°</button>
                    </div>
                </div>
            </div>

            <!-- Â±Ö‰ΩèÂéÜÂè≤Ê†áÁ≠æÈ°µ -->
            <div id="residence" class="tab-content">
                <!-- Â±Ö‰ΩèÂéÜÂè≤ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="stats-section">
                    <h4>üè† Â±Ö‰ΩèÂéÜÂè≤ÁªüËÆ°</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalMoves">-</h3>
                            <p>ÊÄªÊê¨ËøÅÊ¨°Êï∞</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="residenceStatsMessage">-</h3>
                            <p>Ê¥ªË∑ÉÁä∂ÊÄÅ</p>
                        </div>
                    </div>
                </div>

                <!-- ËøáÊª§ÈÄâÈ°π -->
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="residenceUserId">Áî®Êà∑IDÁ≠õÈÄâ:</label>
                            <input type="text" id="residenceUserId" placeholder="ËæìÂÖ•Áî®Êà∑IDËøõË°åÁ≠õÈÄâ">
                        </div>
                        <div class="form-group">
                            <label for="residenceLocation">Â±Ö‰ΩèÂú∞ÁÇπÁ≠õÈÄâ:</label>
                            <select id="residenceLocation">
                                <option value="">ÂÖ®ÈÉ®Âú∞ÁÇπ</option>
                                <option value="castle">üè∞ ÂüéÂ†°</option>
                                <option value="city_hall">üèõÔ∏è Â∏ÇÊîøÂéÖ</option>
                                <option value="palace">üèØ Ë°åÂÆ´</option>
                                <option value="white_dove_house">üïäÔ∏è Â∞èÁôΩÈ∏ΩÂÆ∂</option>
                                <option value="park">üå≥ ÂÖ¨Âõ≠</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Â±Ö‰ΩèÂéÜÂè≤ÂàóË°® -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Áî®Êà∑ID</th>
                                <th>Êê¨ËøÅÂâç</th>
                                <th>Êê¨ËøÅÂêé</th>
                                <th>Êê¨ËøÅÊó∂Èó¥</th>
                                <th>IPÂú∞ÂùÄ</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="residenceHistoryTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">ÁÇπÂáªÂä†ËΩΩÂ±Ö‰ΩèÂéÜÂè≤Êï∞ÊçÆ</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- ÂàÜÈ°µÊéß‰ª∂ -->
                <div class="pagination-section">
                    <div class="pagination-info">
                        <span id="residencePageInfo">Á¨¨ 1 È°µÔºåÂÖ± 0 Êù°ËÆ∞ÂΩï</span>
                    </div>
                    <div class="pagination-controls">
                        <button id="residencePrevPage" onclick="changeResidencePage(-1)" disabled>‰∏ä‰∏ÄÈ°µ</button>
                        <span id="residenceCurrentPage">1</span>
                        <button id="residenceNextPage" onclick="changeResidencePage(1)" disabled>‰∏ã‰∏ÄÈ°µ</button>
                    </div>
                </div>

                <!-- Âä†ËΩΩÊåâÈíÆ -->
                <div class="action-form">
                    <div class="form-row">
                        <button onclick="loadResidenceHistory()" class="action-btn">üîÑ Âà∑Êñ∞Â±Ö‰ΩèÂéÜÂè≤</button>
                        <button onclick="loadResidenceStats()" class="action-btn">üìä Êõ¥Êñ∞ÁªüËÆ°</button>
                    </div>
                </div>
            </div>

            <!-- Áî®Êà∑Â∞ùËØïËÆ∞ÂΩïÊ†áÁ≠æÈ°µ -->
            <div id="attempts" class="tab-content">
                <!-- ËøáÊª§ÈÄâÈ°π -->
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="attemptUserId">Áî®Êà∑IDÁ≠õÈÄâ:</label>
                            <input type="text" id="attemptUserId" placeholder="ËæìÂÖ•Áî®Êà∑IDËøõË°åÁ≠õÈÄâ">
                        </div>
                        <div class="form-group">
                            <label for="attemptHours">Êó∂Èó¥ËåÉÂõ¥:</label>
                            <select id="attemptHours">
                                <option value="1">ÊúÄËøë1Â∞èÊó∂</option>
                                <option value="6">ÊúÄËøë6Â∞èÊó∂</option>
                                <option value="24" selected>ÊúÄËøë24Â∞èÊó∂</option>
                                <option value="72">ÊúÄËøë3Â§©</option>
                                <option value="168">ÊúÄËøë7Â§©</option>
                                <option value="0">ÂÖ®ÈÉ®ËÆ∞ÂΩï</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="attemptLimit">ÊòæÁ§∫Êù°Êï∞:</label>
                            <select id="attemptLimit">
                                <option value="50">50Êù°</option>
                                <option value="100" selected>100Êù°</option>
                                <option value="200">200Êù°</option>
                                <option value="500">500Êù°</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button onclick="loadAttempts()" class="btn btn-primary">üîç Êü•ËØ¢</button>
                            <button onclick="loadAttemptStats()" class="btn btn-secondary">üìä ÁªüËÆ°</button>
                        </div>
                    </div>
                </div>

                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div id="attemptStatsSection" class="stats-section" style="display: none;">
                    <h4>üìä Áî®Êà∑Â∞ùËØïÁªüËÆ°</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalAttempts">-</h3>
                            <p>ÊÄªÂ∞ùËØïÊ¨°Êï∞</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="existentUserAttempts">-</h3>
                            <p>Â∑≤Â≠òÂú®Áî®Êà∑Â∞ùËØï</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="nonExistentUserAttempts">-</h3>
                            <p>‰∏çÂ≠òÂú®Áî®Êà∑Â∞ùËØï</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="nonExistentRate">-</h3>
                            <p>‰∏çÂ≠òÂú®Áî®Êà∑ÊØî‰æã</p>
                        </div>
                    </div>
                </div>

                <!-- Â∞ùËØïËÆ∞ÂΩïË°®Ê†º -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Áî®Êà∑ID</th>
                                <th>Áî®Êà∑Â≠òÂú®</th>
                                <th>IPÂú∞ÂùÄ</th>
                                <th>Áî®Êà∑‰ª£ÁêÜ</th>
                                <th>Â∞ùËØïÊó∂Èó¥</th>
                            </tr>
                        </thead>
                        <tbody id="attemptsTableBody">
                            <!-- Âä®ÊÄÅÂä†ËΩΩ -->
                        </tbody>
                    </table>
                </div>

                <!-- Ê∏ÖÁêÜÊìç‰Ωú -->
                <div class="action-form">
                    <h4>üóëÔ∏è Ê∏ÖÁêÜÊóßËÆ∞ÂΩï</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cleanupDays">Ê∏ÖÁêÜÂ§©Êï∞:</label>
                            <select id="cleanupDays">
                                <option value="7">7Â§©Ââç</option>
                                <option value="30" selected>30Â§©Ââç</option>
                                <option value="90">90Â§©Ââç</option>
                                <option value="365">1Âπ¥Ââç</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button onclick="cleanupAttempts()" class="btn btn-danger">üóëÔ∏è Ê∏ÖÁêÜËÆ∞ÂΩï</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Áî®Êà∑Êìç‰ΩúÊ†áÁ≠æÈ°µ -->
            <div id="actions" class="tab-content">
                <!-- Ê∑ªÂä†Áî®Êà∑ -->
                <div class="action-form">
                    <h4>üìù Ê∑ªÂä†Êñ∞Áî®Êà∑</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="newUserId">Áî®Êà∑IDÔºàÂßìÂêçÔºâ</label>
                            <input type="text" id="newUserId" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂßìÂêç">
                        </div>
                        <div class="form-field">
                            <label for="newUserDaily">ÊØèÊó•ÊäΩÂ•ñÊ¨°Êï∞</label>
                            <input type="number" id="newUserDaily" placeholder="ÈªòËÆ§3Ê¨°" min="1" max="10">
                        </div>
                        <button class="action-btn" onclick="addUser()">Ê∑ªÂä†Áî®Êà∑</button>
                    </div>
                </div>

                <!-- Â¢ûÂä†ÊäΩÂ•ñÊ¨°Êï∞ -->
                <div class="action-form">
                    <h4>üéØ Â¢ûÂä†Áî®Êà∑ÊäΩÂ•ñÊ¨°Êï∞</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="addDrawsUserId">Áî®Êà∑ID</label>
                            <input type="text" id="addDrawsUserId" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂßìÂêç">
                        </div>
                        <div class="form-field">
                            <label for="addDrawsAmount">Â¢ûÂä†Ê¨°Êï∞</label>
                            <input type="number" id="addDrawsAmount" placeholder="1" min="1" max="100">
                        </div>
                        <button class="action-btn" onclick="addUserDraws()">Â¢ûÂä†Ê¨°Êï∞</button>
                    </div>
                </div>

                <!-- ËÆæÁΩÆÊØèÊó•Ê¨°Êï∞ -->
                <div class="action-form">
                    <h4>‚öôÔ∏è ËÆæÁΩÆÁî®Êà∑ÊØèÊó•ÊäΩÂ•ñÊ¨°Êï∞</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="setDailyUserId">Áî®Êà∑ID</label>
                            <input type="text" id="setDailyUserId" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂßìÂêç">
                        </div>
                        <div class="form-field">
                            <label for="setDailyAmount">ÊØèÊó•Ê¨°Êï∞</label>
                            <input type="number" id="setDailyAmount" placeholder="3" min="1" max="10">
                        </div>
                        <button class="action-btn" onclick="setUserDailyDraws()">ËÆæÁΩÆÊ¨°Êï∞</button>
                    </div>
                </div>
            </div>

            <!-- Â±ÖÊâÄ‰∫ã‰ª∂ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
            <div id="residence-events" class="tab-content">
                <!-- Â±ÖÊâÄ‰∫ã‰ª∂ÂéÜÂè≤Ê¶ÇËßà -->
                <div class="action-form">
                    <h4>üè† Â±ÖÊâÄ‰∫ã‰ª∂ÂéÜÂè≤Ê¶ÇËßà</h4>
                    <div id="residenceOverview" style="margin-top: 15px;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            ÁÇπÂáªÂà∑Êñ∞ÊåâÈíÆÂä†ËΩΩÊï∞ÊçÆ
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="action-btn" onclick="loadResidenceEventOverview()">üîÑ Âà∑Êñ∞Ê¶ÇËßà</button>
                    </div>
                </div>

                <!-- Ê∏ÖÈô§Â±ÖÊâÄ‰∫ã‰ª∂ÂéÜÂè≤ -->
                <div class="action-form">
                    <h4>üóëÔ∏è Ê∏ÖÈô§Â±ÖÊâÄ‰∫ã‰ª∂ÂéÜÂè≤</h4>
                    <p style="color: #e53e3e; margin-bottom: 15px; font-size: 14px;">
                        ‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ∏ÖÈô§Êìç‰Ωú‰∏çÂèØÈÄÜÔºåËØ∑Ë∞®ÊÖé‰ΩøÁî®ÔºÅ
                    </p>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="clearResidence">ÈÄâÊã©Â±ÖÊâÄ</label>
                            <select id="clearResidence" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="">ËØ∑ÈÄâÊã©Ë¶ÅÊ∏ÖÈô§ÁöÑÂ±ÖÊâÄ</option>
                                <option value="castle">ÂüéÂ†°üè∞</option>
                                <option value="park">ÂÖ¨Âõ≠üå≥</option>
                                <option value="city_hall">Â∏ÇÊîøÂéÖüèõÔ∏è</option>
                                <option value="white_dove_house">Â∞èÁôΩÈ∏ΩÂÆ∂üïäÔ∏è</option>
                                <option value="palace">Ë°åÂÆ´üèØ</option>
                            </select>
                        </div>
                        <button class="action-btn" onclick="clearResidenceEventHistory()" style="background: #e53e3e;">
                            üóëÔ∏è Ê∏ÖÈô§ÂéÜÂè≤
                        </button>
                    </div>
                </div>
            </div>

            <!-- ÂëΩ‰ª§ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
            <div id="decrees" class="tab-content">
                <div class="action-form">
                    <h4>üìú ÂëΩ‰ª§ÁÆ°ÁêÜ</h4>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        ÁÆ°ÁêÜÁ≥ªÁªüÂëΩ‰ª§ÁöÑÂêçÁß∞ÂíåÊèèËø∞‰ø°ÊÅØ
                    </p>
                    <div id="decreesTable" style="margin-top: 15px;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Âä†ËΩΩ‰∏≠...
                        </div>
                    </div>
                </div>
            </div>

            <!-- È≠îÊ≥ïÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
            <div id="magic" class="tab-content">
                <div class="action-form">
                    <h4>‚ú® È≠îÊ≥ïÁÆ°ÁêÜ</h4>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        ÁÆ°ÁêÜÈ≠îÊ≥ïÁöÑÁ≤æÂäõÊ∂àËÄóÂÄºÔºàÊ≥®ÊÑèÔºöÂ∑≤ÁßªÈô§ÊØèÊó•Ê¨°Êï∞ÈôêÂà∂Ôºå‰ªÖÁ≤æÂäõÈôêÂà∂ÁîüÊïàÔºâ
                    </p>
                    <div id="magicTable" style="margin-top: 15px;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Âä†ËΩΩ‰∏≠...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Â∑®‰∫∫ËøõÊîªÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
            <div id="giant-attack" class="tab-content">
                <!-- Â∑®‰∫∫ËøõÊîªÁä∂ÊÄÅ -->
                <div class="stats-section">
                    <h4>üëπ Â∑®‰∫∫ËøõÊîªÁä∂ÊÄÅ</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="giantAttackStatus">-</h3>
                            <p>ÂΩìÂâçÁä∂ÊÄÅ</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="giantAttackTime">-</h3>
                            <p>ËøõÊîªÊó∂Èó¥</p>
                        </div>
                    </div>
                </div>

                <!-- Â∑®‰∫∫ËøõÊîªÊéßÂà∂ -->
                <div class="action-form">
                    <h4>üéÆ Â∑®‰∫∫ËøõÊîªÊéßÂà∂</h4>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        ÊâãÂä®ÊéßÂà∂Â∑®‰∫∫ËøõÊîªÁöÑÂºÄÂßãÂíåÁªìÊùü
                    </p>
                    <div class="form-row">
                        <button onclick="triggerGiantAttack()" class="action-btn" style="background: #e53e3e;">
                            üëπ Ëß¶ÂèëÂ∑®‰∫∫ËøõÊîª
                        </button>
                        <button onclick="endGiantAttack()" class="action-btn" style="background: #48bb78;">
                            üõ°Ô∏è ÁªìÊùüÂ∑®‰∫∫ËøõÊîª
                        </button>
                        <button onclick="processGiantDamage()" class="action-btn" style="background: #ed8936;">
                            ‚öîÔ∏è Â§ÑÁêÜÂ∑®‰∫∫‰º§ÂÆ≥
                        </button>
                        <button onclick="loadGiantAttackStatus()" class="action-btn">
                            üîÑ Âà∑Êñ∞Áä∂ÊÄÅ
                        </button>
                    </div>
                </div>

                <!-- Â∑®‰∫∫ËøõÊîªÂéÜÂè≤ -->
                <div class="action-form">
                    <h4>üìä Â∑®‰∫∫ËøõÊîªÂéÜÂè≤</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Áä∂ÊÄÅ</th>
                                    <th>ÂºÄÂßãÊó∂Èó¥</th>
                                    <th>ÁªìÊùüÊó∂Èó¥</th>
                                    <th>ÊúÄÂêé‰º§ÂÆ≥Êó∂Èó¥</th>
                                    <th>ÂàõÂª∫Êó∂Èó¥</th>
                                </tr>
                            </thead>
                            <tbody id="giantAttackHistoryTable">
                                <tr><td colspan="6" style="text-align: center; padding: 20px;">ÁÇπÂáªÂà∑Êñ∞Áä∂ÊÄÅÂä†ËΩΩÊï∞ÊçÆ</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let adminToken = null;

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // Ê£ÄÊü•Êú¨Âú∞Â≠òÂÇ®ÁöÑtoken
            adminToken = localStorage.getItem('adminToken');
            if (adminToken) {
                validateTokenAndShowAdmin();
            }

            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Ê†áÁ≠æÈ°µÂàáÊç¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
        });

        // Â§ÑÁêÜÁôªÂΩï
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (result.success) {
                    adminToken = result.data.token;
                    localStorage.setItem('adminToken', adminToken);
                    showMessage('loginMessage', 'ÁôªÂΩïÊàêÂäüÔºÅ', 'success');
                    setTimeout(() => {
                        showAdminPanel();
                    }, 1000);
                } else {
                    showMessage('loginMessage', result.message || 'ÁôªÂΩïÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('ÁôªÂΩïÈîôËØØ:', error);
                showMessage('loginMessage', 'ÁΩëÁªúËøûÊé•Â§±Ë¥•', 'error');
            }
        }

        // È™åËØÅtokenÂπ∂ÊòæÁ§∫ÁÆ°ÁêÜÈù¢Êùø
        async function validateTokenAndShowAdmin() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    showAdminPanel();
                } else {
                    // TokenÊó†ÊïàÔºåÊ∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®
                    localStorage.removeItem('adminToken');
                    adminToken = null;
                }
            } catch (error) {
                console.error('TokenÈ™åËØÅÈîôËØØ:', error);
                localStorage.removeItem('adminToken');
                adminToken = null;
            }
        }

        // ÊòæÁ§∫ÁÆ°ÁêÜÈù¢Êùø
        function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadStats();
            loadUsers();
        }

        // Â§ÑÁêÜÁôªÂá∫
        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/admin/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
            } catch (error) {
                console.error('ÁôªÂá∫ÈîôËØØ:', error);
            }

            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // ÂàáÊç¢Ê†áÁ≠æÈ°µ
        function switchTab(tabName) {
            // Êõ¥Êñ∞Ê†áÁ≠æÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });

            // Êõ¥Êñ∞ÂÜÖÂÆπÊòæÁ§∫
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Âä†ËΩΩÂØπÂ∫îÊï∞ÊçÆ
            if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'attempts') {
                loadAttempts();
            } else if (tabName === 'wishes') {
                loadWishes();
                loadWishStats();
            } else if (tabName === 'residence') {
                loadResidenceHistory();
                loadResidenceStats();
            } else if (tabName === 'residence-events') {
                loadResidenceEventOverview();
            } else if (tabName === 'decrees') {
                loadDecrees();
            } else if (tabName === 'magic') {
                loadMagics();
            } else if (tabName === 'giant-attack') {
                loadGiantAttackStatus();
            }
        }

        // Âä†ËΩΩÂëΩ‰ª§ÂàóË°®
        async function loadDecrees() {
            try {
                const response = await fetch(`${API_BASE}/admin/decrees`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    displayDecrees(data.data);
                } else {
                    document.getElementById('decreesTable').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e53e3e;">
                            ${data.message || 'Âä†ËΩΩÂëΩ‰ª§Â§±Ë¥•'}
                        </div>`;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂëΩ‰ª§Â§±Ë¥•:', error);
                document.getElementById('decreesTable').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e53e3e;">
                        Âä†ËΩΩÂëΩ‰ª§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï
                    </div>`;
            }
        }

        // ÊòæÁ§∫ÂëΩ‰ª§ÂàóË°®
        function displayDecrees(decrees) {
            if (!decrees || decrees.length === 0) {
                document.getElementById('decreesTable').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        ÊöÇÊó†ÂëΩ‰ª§
                    </div>`;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
            
            decrees.forEach(decree => {
                const statusBadge = decree.active ? 
                    '<span style="background: #48bb78; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px;">Â∑≤ÊøÄÊ¥ª</span>' :
                    '<span style="background: #cbd5e0; color: #4a5568; padding: 3px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px;">Êú™ÊøÄÊ¥ª</span>';

                html += `
                    <div style="border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 5px 0; font-size: 18px; color: #2d3748;">
                                    ${decree.name || 'Êú™ÂëΩÂêç'}
                                    ${statusBadge}
                                </h5>
                                <p style="margin: 0; font-size: 12px; color: #a0aec0;">
                                    ‰ª£Á†Å: ${decree.code}
                                </p>
                            </div>
                            <button class="action-btn" onclick="editDecree('${decree.code}')" style="padding: 8px 16px; font-size: 14px;">
                                ‚úèÔ∏è ÁºñËæë
                            </button>
                        </div>
                        <div style="background: #f7fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #667eea;">
                            <p style="margin: 0; font-size: 14px; color: #4a5568; line-height: 1.6;">
                                ${decree.description || 'Êó†ÊèèËø∞'}
                            </p>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('decreesTable').innerHTML = html;
        }

        // ÁºñËæëÂëΩ‰ª§
        function editDecree(code) {
            fetch(`${API_BASE}/admin/decrees`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    const decree = data.data.find(d => d.code === code);
                    if (decree) {
                        showDecreeEditDialog(decree);
                    }
                }
            });
        }

        // ÊòæÁ§∫ÂëΩ‰ª§ÁºñËæëÂØπËØùÊ°Ü
        function showDecreeEditDialog(decree) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);">
                    <h3 style="margin: 0 0 20px 0; color: #2d3748;">ÁºñËæëÂëΩ‰ª§‰ø°ÊÅØ</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: bold;">ÂëΩ‰ª§‰ª£Á†ÅÔºà‰∏çÂèØ‰øÆÊîπÔºâ</label>
                        <input type="text" value="${decree.code}" disabled style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f7fafc; color: #a0aec0;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: bold;">ÂëΩ‰ª§ÂêçÁß∞ *</label>
                        <input type="text" id="decreeName" value="${decree.name || ''}" placeholder="ËæìÂÖ•ÂëΩ‰ª§ÂêçÁß∞" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: bold;">ÂëΩ‰ª§ÊèèËø∞</label>
                        <textarea id="decreeDescription" placeholder="ËæìÂÖ•ÂëΩ‰ª§ÊèèËø∞" style="width: 100%; min-height: 120px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; resize: vertical;">${decree.description || ''}</textarea>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="padding: 10px 20px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #4a5568; cursor: pointer; font-size: 14px;">
                            ÂèñÊ∂à
                        </button>
                        <button onclick="saveDecree('${decree.code}')" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; font-size: 14px; font-weight: bold;">
                            ‰øùÂ≠ò
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ‰øùÂ≠òÂëΩ‰ª§
        async function saveDecree(code) {
            const name = document.getElementById('decreeName').value.trim();
            const description = document.getElementById('decreeDescription').value.trim();

            if (!name) {
                alert('ÂëΩ‰ª§ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/decree/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        code: code,
                        name: name,
                        description: description
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('ÂëΩ‰ª§‰ø°ÊÅØÊõ¥Êñ∞ÊàêÂäüÔºÅ');
                    // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
                    document.querySelector('div[style*="position: fixed"]').remove();
                    // ÈáçÊñ∞Âä†ËΩΩÂëΩ‰ª§ÂàóË°®
                    loadDecrees();
                } else {
                    alert('Êõ¥Êñ∞Â§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                console.error('‰øùÂ≠òÂëΩ‰ª§Â§±Ë¥•:', error);
                alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        // Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØ
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('totalUsers').textContent = result.data.totalUsers;
                    document.getElementById('activeUsers').textContent = result.data.totalActiveUsers;
                    document.getElementById('totalDraws').textContent = result.data.lotteryStats.totalDraws;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØÈîôËØØ:', error);
            }
        }

        // Âä†ËΩΩÁî®Êà∑ÂàóË°®
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tbody = document.getElementById('usersTable');
                    tbody.innerHTML = '';

                    result.data.forEach(user => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${user.userId}</td>
                            <td>${user.remainingDraws}</td>
                            <td>${user.dailyDraws}</td>
                            <td>
                                <div class="profile-cell">
                                    <span class="profile-text" title="${user.profile || 'Ëøô‰∏™‰∫∫ÂæàÁ•ûÁßòÔºå‰ªÄ‰πàÈÉΩÊ≤°ÊúâÁïô‰∏ã...'}">${truncateText(user.profile || 'Ëøô‰∏™‰∫∫ÂæàÁ•ûÁßòÔºå‰ªÄ‰πàÈÉΩÊ≤°ÊúâÁïô‰∏ã...', 20)}</span>
                                    <button class="edit-btn" onclick="editUserProfile('${user.userId}', '${escapeHtml(user.profile || '')}')" title="ÁºñËæëÁÆÄ‰ªã">‚úèÔ∏è</button>
                                </div>
                            </td>
                            <td>
                                <div class="status-cell">
                                    <span class="status-text">${user.status || 'ÂÆâÂ±Ö‰πê‰∏ö‰∏≠'}</span>
                                    <button class="edit-btn" onclick="editUserStatus('${user.userId}', '${escapeHtml(user.status || '')}')" title="ÁºñËæëÁä∂ÊÄÅ">‚úèÔ∏è</button>
                                </div>
                            </td>
                            <td>${new Date(user.createTime).toLocaleString()}</td>
                            <td>${new Date(user.lastRefreshDate).toLocaleString()}</td>
                            <td>
                                <button class="delete-btn" onclick="deleteUser('${user.userId}')" title="Âà†Èô§Áî®Êà∑">
                                    üóëÔ∏è Âà†Èô§
                                </button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑ÂàóË°®ÈîôËØØ:', error);
            }
        }

        // ÂàÜÈ°µÁõ∏ÂÖ≥ÂèòÈáè
        let currentHistoryPage = 1;
        let historyPageSize = 20;
        let historyTotalPages = 1;
        let historyTotalCount = 0;

        // Âä†ËΩΩÊäΩÂ•ñÂéÜÂè≤ÔºàÂàÜÈ°µÔºâ
        async function loadHistory(page = 1) {
            try {
                const userId = document.getElementById('historyUserId').value.trim();
                const pageSize = document.getElementById('historyPageSize').value;
                
                let url = `${API_BASE}/admin/lottery-history?page=${page}&size=${pageSize}`;
                if (userId) {
                    url += `&userId=${encodeURIComponent(userId)}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    
                    // Êõ¥Êñ∞ÂàÜÈ°µÂèòÈáè
                    currentHistoryPage = data.pagination.currentPage;
                    historyPageSize = data.pagination.pageSize;
                    historyTotalPages = data.pagination.totalPages;
                    historyTotalCount = data.pagination.totalCount;

                    // Êõ¥Êñ∞Ë°®Ê†ºÂÜÖÂÆπ
                    const tbody = document.getElementById('historyTable');
                    tbody.innerHTML = '';

                    if (data.records.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
                    } else {
                        data.records.forEach(record => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${record.id}</td>
                                <td><strong>${record.userId}</strong></td>
                                <td>${record.prizeName}</td>
                                <td><span class="badge badge-${getBadgeClass(record.prizeLevel)}">${record.prizeLevel}</span></td>
                                <td>${record.ipAddress || '-'}</td>
                                <td>${new Date(record.createTime).toLocaleString()}</td>
                            `;
                        });
                    }

                    // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
                    updateHistoryPagination();
                    
                    // ÊòæÁ§∫ÂàÜÈ°µÊéß‰ª∂
                    document.getElementById('historyPagination').style.display = 'flex';
                } else {
                    showMessage('adminMessage', result.message || 'Âä†ËΩΩÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊäΩÂ•ñÂéÜÂè≤ÈîôËØØ:', error);
                showMessage('adminMessage', 'Âä†ËΩΩÊäΩÂ•ñÂéÜÂè≤Â§±Ë¥•', 'error');
            }
        }

        // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØÂíåÊéß‰ª∂
        function updateHistoryPagination() {
            // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØÊñáÊú¨
            const startRecord = (currentHistoryPage - 1) * historyPageSize + 1;
            const endRecord = Math.min(currentHistoryPage * historyPageSize, historyTotalCount);
            document.getElementById('historyPaginationInfo').textContent = 
                `ÊòæÁ§∫Á¨¨ ${startRecord}-${endRecord} Êù°ÔºåÂÖ± ${historyTotalCount} Êù°ËÆ∞ÂΩï`;

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('historyFirstPage').disabled = currentHistoryPage === 1;
            document.getElementById('historyPrevPage').disabled = currentHistoryPage === 1;
            document.getElementById('historyNextPage').disabled = currentHistoryPage === historyTotalPages;
            document.getElementById('historyLastPage').disabled = currentHistoryPage === historyTotalPages;

            // Êõ¥Êñ∞È°µÁ†Å
            updateHistoryPageNumbers();
        }

        // Êõ¥Êñ∞È°µÁ†ÅÊòæÁ§∫
        function updateHistoryPageNumbers() {
            const pageNumbers = document.getElementById('historyPageNumbers');
            pageNumbers.innerHTML = '';

            const maxShowPages = 5;
            let startPage = Math.max(1, currentHistoryPage - Math.floor(maxShowPages / 2));
            let endPage = Math.min(historyTotalPages, startPage + maxShowPages - 1);

            if (endPage - startPage + 1 < maxShowPages) {
                startPage = Math.max(1, endPage - maxShowPages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('span');
                pageBtn.className = `page-number ${i === currentHistoryPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => loadHistory(i);
                pageNumbers.appendChild(pageBtn);
            }
        }

        // ÂàÜÈ°µÂØºËà™ÂáΩÊï∞
        function loadHistoryPrevPage() {
            if (currentHistoryPage > 1) {
                loadHistory(currentHistoryPage - 1);
            }
        }

        function loadHistoryNextPage() {
            if (currentHistoryPage < historyTotalPages) {
                loadHistory(currentHistoryPage + 1);
            }
        }

        function loadHistoryLastPage() {
            loadHistory(historyTotalPages);
        }

        // Ê∏ÖÈô§Á≠õÈÄâ
        function clearHistoryFilter() {
            document.getElementById('historyUserId').value = '';
            document.getElementById('historyPageSize').value = '20';
            loadHistory(1);
        }

        // Ëé∑ÂèñÂæΩÁ´†Ê†∑ÂºèÁ±ª
        function getBadgeClass(level) {
            const levelMap = {
                'common': 'secondary',
                'uncommon': 'primary', 
                'rare': 'warning',
                'epic': 'danger',
                'special': 'success'
            };
            return levelMap[level] || 'secondary';
        }

        // Ê∑ªÂä†Áî®Êà∑
        async function addUser() {
            const userId = document.getElementById('newUserId').value.trim();
            const dailyDraws = parseInt(document.getElementById('newUserDaily').value) || 3;

            if (!userId) {
                showMessage('adminMessage', 'ËØ∑ËæìÂÖ•Áî®Êà∑ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ userId, dailyDraws })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', 'Áî®Êà∑Ê∑ªÂä†ÊàêÂäüÔºÅ', 'success');
                    document.getElementById('newUserId').value = '';
                    document.getElementById('newUserDaily').value = '';
                    loadUsers();
                    loadStats();
                } else {
                    showMessage('adminMessage', result.message || 'Ê∑ªÂä†Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ê∑ªÂä†Áî®Êà∑ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // Â¢ûÂä†Áî®Êà∑ÊäΩÂ•ñÊ¨°Êï∞
        async function addUserDraws() {
            const userId = document.getElementById('addDrawsUserId').value.trim();
            const amount = parseInt(document.getElementById('addDrawsAmount').value) || 1;

            if (!userId) {
                showMessage('adminMessage', 'ËØ∑ËæìÂÖ•Áî®Êà∑ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/add-draws`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ userId, remainingDraws: amount })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `ÊàêÂäü‰∏∫Áî®Êà∑ ${userId} Â¢ûÂä† ${amount} Ê¨°ÊäΩÂ•ñÊú∫‰ºöÔºÅ`, 'success');
                    document.getElementById('addDrawsUserId').value = '';
                    document.getElementById('addDrawsAmount').value = '';
                    loadUsers();
                } else {
                    showMessage('adminMessage', result.message || 'Êìç‰ΩúÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Â¢ûÂä†ÊäΩÂ•ñÊ¨°Êï∞ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // ËÆæÁΩÆÁî®Êà∑ÊØèÊó•ÊäΩÂ•ñÊ¨°Êï∞
        async function setUserDailyDraws() {
            const userId = document.getElementById('setDailyUserId').value.trim();
            const dailyDraws = parseInt(document.getElementById('setDailyAmount').value) || 3;

            if (!userId) {
                showMessage('adminMessage', 'ËØ∑ËæìÂÖ•Áî®Êà∑ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/set-daily-draws`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ userId, dailyDraws })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `ÊàêÂäüËÆæÁΩÆÁî®Êà∑ ${userId} ÊØèÊó•ÊäΩÂ•ñÊ¨°Êï∞‰∏∫ ${dailyDraws} Ê¨°ÔºÅ`, 'success');
                    document.getElementById('setDailyUserId').value = '';
                    document.getElementById('setDailyAmount').value = '';
                    loadUsers();
                } else {
                    showMessage('adminMessage', result.message || 'Êìç‰ΩúÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('ËÆæÁΩÆÊØèÊó•ÊäΩÂ•ñÊ¨°Êï∞ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // Âà†Èô§Áî®Êà∑
        async function deleteUser(userId) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Áî®Êà∑ "${userId}" ÂêóÔºü\n\n‚ö†Ô∏è Ë≠¶ÂëäÔºöÂà†Èô§ÂêéËØ•Áî®Êà∑ÁöÑÊâÄÊúâÊï∞ÊçÆÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºÅ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/${encodeURIComponent(userId)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `Áî®Êà∑ ${userId} Âà†Èô§ÊàêÂäüÔºÅ`, 'success');
                    loadUsers(); // Âà∑Êñ∞Áî®Êà∑ÂàóË°®
                    loadStats(); // Âà∑Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                } else {
                    showMessage('adminMessage', result.message || 'Âà†Èô§Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âà†Èô§Áî®Êà∑ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // Âä†ËΩΩÁî®Êà∑Â∞ùËØïËÆ∞ÂΩï
        async function loadAttempts() {
            try {
                const userId = document.getElementById('attemptUserId').value.trim();
                const hours = document.getElementById('attemptHours').value;
                const limit = document.getElementById('attemptLimit').value;
                
                let url = `${API_BASE}/admin/user-attempts?limit=${limit}`;
                if (userId) {
                    url += `&userId=${encodeURIComponent(userId)}`;
                } else if (hours > 0) {
                    url += `&hours=${hours}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tableBody = document.getElementById('attemptsTableBody');
                    if (result.data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = result.data.map(attempt => `
                        <tr>
                            <td>${attempt.id}</td>
                            <td><strong>${attempt.attemptUserId}</strong></td>
                            <td>
                                <span class="badge ${attempt.userExists ? 'badge-success' : 'badge-danger'}">
                                    ${attempt.userExists ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}
                                </span>
                            </td>
                            <td>${attempt.ipAddress || '-'}</td>
                            <td title="${attempt.userAgent || '-'}" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${attempt.userAgent ? attempt.userAgent.substring(0, 50) + (attempt.userAgent.length > 50 ? '...' : '') : '-'}
                            </td>
                            <td>${new Date(attempt.attemptTime).toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑Â∞ùËØïËÆ∞ÂΩïÈîôËØØ:', error);
                showMessage('adminMessage', 'Âä†ËΩΩÁî®Êà∑Â∞ùËØïËÆ∞ÂΩïÂ§±Ë¥•', 'error');
            }
        }

        // Âä†ËΩΩÁî®Êà∑Â∞ùËØïÁªüËÆ°
        async function loadAttemptStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/user-attempts/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('totalAttempts').textContent = stats.totalAttempts || 0;
                    document.getElementById('existentUserAttempts').textContent = stats.existentUserAttempts || 0;
                    document.getElementById('nonExistentUserAttempts').textContent = stats.nonExistentUserAttempts || 0;
                    document.getElementById('nonExistentRate').textContent = (stats.nonExistentRate || 0).toFixed(1) + '%';
                    
                    // ÊòæÁ§∫ÁªüËÆ°Âå∫Âüü
                    document.getElementById('attemptStatsSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑Â∞ùËØïÁªüËÆ°ÈîôËØØ:', error);
                showMessage('adminMessage', 'Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•', 'error');
            }
        }

        // Ê∏ÖÁêÜÊóßÁöÑÁî®Êà∑Â∞ùËØïËÆ∞ÂΩï
        async function cleanupAttempts() {
            const days = document.getElementById('cleanupDays').value;
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜ ${days} Â§©ÂâçÁöÑÁî®Êà∑Â∞ùËØïËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/user-attempts/cleanup?days=${days}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `Ê∏ÖÁêÜÂÆåÊàêÔºÅÂà†Èô§‰∫Ü ${result.data.deletedCount} Êù°ËÆ∞ÂΩï`, 'success');
                    loadAttempts(); // Âà∑Êñ∞ÂàóË°®
                    loadAttemptStats(); // Âà∑Êñ∞ÁªüËÆ°
                } else {
                    showMessage('adminMessage', result.message || 'Ê∏ÖÁêÜÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ê∏ÖÁêÜÁî®Êà∑Â∞ùËØïËÆ∞ÂΩïÈîôËØØ:', error);
                showMessage('adminMessage', 'Ê∏ÖÁêÜÂ§±Ë¥•', 'error');
            }
        }

        // Âä†ËΩΩÊÑøÊúõÂàóË°®
        async function loadWishes() {
            try {
                const response = await fetch(`${API_BASE}/admin/wishes`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tbody = document.getElementById('wishesTable');
                    tbody.innerHTML = '';

                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">ÊöÇÊó†ÊÑøÊúõÊï∞ÊçÆ</td></tr>';
                        return;
                    }

                    result.data.forEach(wish => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${wish.id}</td>
                            <td><strong>${wish.userId}</strong></td>
                            <td style="max-width: 200px; word-break: break-all; line-height: 1.4;">
                                <span title="${wish.wishContent}">${wish.wishContent}</span>
                            </td>
                            <td>
                                <small>X: ${wish.starX.toFixed(1)}%<br>Y: ${wish.starY.toFixed(1)}%</small>
                            </td>
                            <td>
                                <span class="badge badge-primary">‚≠ê ${wish.starSize}</span>
                            </td>
                            <td>
                                <small>${new Date(wish.createTime).toLocaleString()}</small>
                            </td>
                            <td>
                                <button class="delete-btn" onclick="deleteWish(${wish.id}, '${wish.userId}', '${wish.wishContent.replace(/'/g, "\\'")}')" title="Âà†Èô§ÊÑøÊúõ">
                                    üóëÔ∏è Âà†Èô§
                                </button>
                            </td>
                        `;
                    });
                } else {
                    showMessage('adminMessage', result.message || 'Âä†ËΩΩÊÑøÊúõÂàóË°®Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊÑøÊúõÂàóË°®ÈîôËØØ:', error);
                showMessage('adminMessage', 'Âä†ËΩΩÊÑøÊúõÂàóË°®Â§±Ë¥•', 'error');
            }
        }

        // Âä†ËΩΩÊÑøÊúõÁªüËÆ°‰ø°ÊÅØ
        async function loadWishStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/wishes/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('totalWishes').textContent = result.data.totalWishes || 0;
                    document.getElementById('wishStatsMessage').textContent = '‚ú®Èó™ËÄÄ‰∏≠';
                } else {
                    document.getElementById('totalWishes').textContent = '?';
                    document.getElementById('wishStatsMessage').textContent = 'Âä†ËΩΩÂ§±Ë¥•';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊÑøÊúõÁªüËÆ°ÈîôËØØ:', error);
                document.getElementById('totalWishes').textContent = '?';
                document.getElementById('wishStatsMessage').textContent = 'ÁΩëÁªúÈîôËØØ';
            }
        }

        // Âà†Èô§ÊÑøÊúõ
        async function deleteWish(wishId, userId, wishContent) {
            // Êà™Êñ≠ËøáÈïøÁöÑÊÑøÊúõÂÜÖÂÆπÁî®‰∫éÊòæÁ§∫
            const displayContent = wishContent.length > 20 ? wishContent.substring(0, 20) + '...' : wishContent;
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊÑøÊúõÂêóÔºü\n\nÁî®Êà∑Ôºö${userId}\nÂÜÖÂÆπÔºö${displayContent}\n\n‚ö†Ô∏è Ë≠¶ÂëäÔºöÂà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§çÔºåÊòüÁ©∫‰∏≠ÁöÑÊòüÊòü‰πü‰ºöÊ∂àÂ§±ÔºÅ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/wishes/${wishId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `ÊÑøÊúõÂà†Èô§ÊàêÂäüÔºÅÁî®Êà∑ ${userId} ÁöÑÊÑøÊúõÂ∑≤‰ªéÊòüÁ©∫‰∏≠ÁßªÈô§„ÄÇ`, 'success');
                    loadWishes(); // Âà∑Êñ∞ÊÑøÊúõÂàóË°®
                    loadWishStats(); // Âà∑Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                } else {
                    showMessage('adminMessage', result.message || 'Âà†Èô§ÊÑøÊúõÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âà†Èô§ÊÑøÊúõÈîôËØØ:', error);
                showMessage('adminMessage', 'Âà†Èô§ÊÑøÊúõÂ§±Ë¥•', 'error');
            }
        }

        // Â±Ö‰ΩèÂéÜÂè≤ÁÆ°ÁêÜÁõ∏ÂÖ≥ÂèòÈáè
        let residenceCurrentPage = 1;
        let residencePageSize = 20;
        let residenceTotalPages = 0;

        // Âä†ËΩΩÂ±Ö‰ΩèÂéÜÂè≤ËÆ∞ÂΩï
        async function loadResidenceHistory(page = 1) {
            try {
                residenceCurrentPage = page;
                const response = await fetch(`${API_BASE}/admin/residence-history?page=${page}&size=${residencePageSize}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tbody = document.getElementById('residenceHistoryTable');
                    tbody.innerHTML = '';

                    if (result.data.records.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">ÊöÇÊó†Â±Ö‰ΩèÂéÜÂè≤Êï∞ÊçÆ</td></tr>';
                        return;
                    }

                    result.data.records.forEach(record => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${record.id}</td>
                            <td><strong>${record.userId}</strong></td>
                            <td>
                                <span class="badge badge-secondary">${getResidenceName(record.previousResidence)}</span>
                            </td>
                            <td>
                                <span class="badge badge-primary">${getResidenceName(record.residence)}</span>
                            </td>
                            <td>
                                <small>${new Date(record.changeTime).toLocaleString()}</small>
                            </td>
                            <td>
                                <small title="${record.userAgent || 'N/A'}">${record.ipAddress || 'N/A'}</small>
                            </td>
                            <td>
                                <button class="delete-btn" onclick="deleteResidenceHistory(${record.id}, '${record.userId}')" title="Âà†Èô§ËÆ∞ÂΩï">
                                    üóëÔ∏è Âà†Èô§
                                </button>
                            </td>
                        `;
                    });

                    // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
                    residenceTotalPages = result.data.totalPages;
                    document.getElementById('residencePageInfo').textContent = 
                        `Á¨¨ ${page} È°µÔºåÂÖ± ${result.data.total} Êù°ËÆ∞ÂΩï`;
                    document.getElementById('residenceCurrentPage').textContent = page;
                    
                    // Êõ¥Êñ∞ÂàÜÈ°µÊåâÈíÆÁä∂ÊÄÅ
                    document.getElementById('residencePrevPage').disabled = page <= 1;
                    document.getElementById('residenceNextPage').disabled = page >= residenceTotalPages;
                } else {
                    showMessage('adminMessage', result.message || 'Âä†ËΩΩÂ±Ö‰ΩèÂéÜÂè≤Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ±Ö‰ΩèÂéÜÂè≤ÈîôËØØ:', error);
                showMessage('adminMessage', 'Âä†ËΩΩÂ±Ö‰ΩèÂéÜÂè≤Â§±Ë¥•', 'error');
            }
        }

        // Âä†ËΩΩÂ±Ö‰ΩèÂéÜÂè≤ÁªüËÆ°‰ø°ÊÅØ
        async function loadResidenceStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/residence-history/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('totalMoves').textContent = result.data.totalMoves || 0;
                    document.getElementById('residenceStatsMessage').textContent = 'üè†Ê¥ªË∑É‰∏≠';
                } else {
                    document.getElementById('totalMoves').textContent = '?';
                    document.getElementById('residenceStatsMessage').textContent = 'Âä†ËΩΩÂ§±Ë¥•';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ±Ö‰ΩèÂéÜÂè≤ÁªüËÆ°ÈîôËØØ:', error);
                document.getElementById('totalMoves').textContent = '?';
                document.getElementById('residenceStatsMessage').textContent = 'ÁΩëÁªúÈîôËØØ';
            }
        }

        // Âà†Èô§Â±Ö‰ΩèÂéÜÂè≤ËÆ∞ÂΩï
        async function deleteResidenceHistory(historyId, userId) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Áî®Êà∑ ${userId} ÁöÑËøôÊù°Â±Ö‰ΩèÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü\n\n‚ö†Ô∏è Ë≠¶ÂëäÔºöÂà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§çÔºÅ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/residence-history/${historyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `Â±Ö‰ΩèÂéÜÂè≤ËÆ∞ÂΩïÂà†Èô§ÊàêÂäüÔºÅÁî®Êà∑ ${userId} ÁöÑËÆ∞ÂΩïÂ∑≤ÁßªÈô§„ÄÇ`, 'success');
                    loadResidenceHistory(residenceCurrentPage); // Âà∑Êñ∞ÂΩìÂâçÈ°µ
                    loadResidenceStats(); // Âà∑Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                } else {
                    showMessage('adminMessage', result.message || 'Âà†Èô§Â±Ö‰ΩèÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âà†Èô§Â±Ö‰ΩèÂéÜÂè≤ËÆ∞ÂΩïÈîôËØØ:', error);
                showMessage('adminMessage', 'Âà†Èô§Â±Ö‰ΩèÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•', 'error');
            }
        }

        // ÊîπÂèòÂ±Ö‰ΩèÂéÜÂè≤È°µÁ†Å
        function changeResidencePage(direction) {
            const newPage = residenceCurrentPage + direction;
            if (newPage >= 1 && newPage <= residenceTotalPages) {
                loadResidenceHistory(newPage);
            }
        }

        // Ëé∑ÂèñÂ±Ö‰ΩèÂú∞ÁÇπÁöÑ‰∏≠ÊñáÂêçÁß∞
        function getResidenceName(residence) {
            if (!residence) {
                return 'Êú™ÈÄâÊã©';
            }
            
            const residenceNames = {
                'castle': 'üè∞ ÂüéÂ†°',
                'city_hall': 'üèõÔ∏è Â∏ÇÊîøÂéÖ',
                'palace': 'üèØ Ë°åÂÆ´',
                'white_dove_house': 'üïäÔ∏è Â∞èÁôΩÈ∏ΩÂÆ∂',
                'park': 'üå≥ ÂÖ¨Âõ≠'
            };
            
            return residenceNames[residence] || 'Êú™Áü•Âú∞ÁÇπ';
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // 3ÁßíÂêéËá™Âä®Ê∏ÖÈô§Ê∂àÊÅØ
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // Âä†ËΩΩÂ±ÖÊâÄ‰∫ã‰ª∂ÂéÜÂè≤Ê¶ÇËßà
        async function loadResidenceEventOverview() {
            try {
                const response = await fetch(`${API_BASE}/admin/residence-event-history/overview`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const overviewContainer = document.getElementById('residenceOverview');
                    const overview = result.data.overview;
                    
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
                    
                    Object.keys(overview).forEach(residence => {
                        const data = overview[residence];
                        html += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="font-weight: bold; margin-bottom: 8px; color: #333;">
                                    ${data.residenceName}
                                </div>
                                <div style="font-size: 24px; color: #667eea; font-weight: bold; margin-bottom: 5px;">
                                    ${data.totalCount || 0}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    ‰∫ã‰ª∂ÂéÜÂè≤ËÆ∞ÂΩï
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    overviewContainer.innerHTML = html;
                } else {
                    document.getElementById('residenceOverview').innerHTML = 
                        `<div style="text-align: center; padding: 20px; color: #e53e3e;">
                            Âä†ËΩΩÂ§±Ë¥•Ôºö${result.message}
                        </div>`;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ±ÖÊâÄ‰∫ã‰ª∂Ê¶ÇËßàÈîôËØØ:', error);
                document.getElementById('residenceOverview').innerHTML = 
                    `<div style="text-align: center; padding: 20px; color: #e53e3e;">
                        ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï
                    </div>`;
            }
        }

        // Ê∏ÖÈô§Â±ÖÊâÄ‰∫ã‰ª∂ÂéÜÂè≤
        async function clearResidenceEventHistory() {
            const residence = document.getElementById('clearResidence').value;
            
            if (!residence) {
                showMessage('adminMessage', 'ËØ∑ÈÄâÊã©Ë¶ÅÊ∏ÖÈô§ÁöÑÂ±ÖÊâÄ', 'error');
                return;
            }

            // Ëé∑ÂèñÂ±ÖÊâÄÊòæÁ§∫ÂêçÁß∞
            const residenceNames = {
                'castle': 'ÂüéÂ†°üè∞',
                'park': 'ÂÖ¨Âõ≠üå≥',
                'city_hall': 'Â∏ÇÊîøÂéÖüèõÔ∏è',
                'white_dove_house': 'Â∞èÁôΩÈ∏ΩÂÆ∂üïäÔ∏è',
                'palace': 'Ë°åÂÆ´üèØ'
            };
            const residenceName = residenceNames[residence] || residence;

            // Á°ÆËÆ§ÂØπËØùÊ°Ü
            if (!confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ "${residenceName}" ÁöÑÊâÄÊúâ‰∫ã‰ª∂ÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü\n\n‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜÔºåÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÂ∞ÜÊ∞∏‰πÖÂà†Èô§ÔºÅ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/residence-event-history/${residence}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `${residenceName} ÁöÑ‰∫ã‰ª∂ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÊ∏ÖÈô§ÔºÅ`, 'success');
                    document.getElementById('clearResidence').value = '';
                    // Âà∑Êñ∞Ê¶ÇËßàÊï∞ÊçÆ
                    loadResidenceEventOverview();
                } else {
                    showMessage('adminMessage', result.message || 'Ê∏ÖÈô§Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ê∏ÖÈô§Â±ÖÊâÄ‰∫ã‰ª∂ÂéÜÂè≤ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }
        }

        // ËæÖÂä©ÂáΩÊï∞ÔºöÊà™Êñ≠ÊñáÊú¨
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // ËæÖÂä©ÂáΩÊï∞ÔºöËΩ¨‰πâHTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ÁºñËæëÁî®Êà∑ÁÆÄ‰ªã
        async function editUserProfile(userId, currentProfile) {
            const newProfile = prompt('ÁºñËæëÁî®Êà∑ÁÆÄ‰ªã:', currentProfile || 'Ëøô‰∏™‰∫∫ÂæàÁ•ûÁßòÔºå‰ªÄ‰πàÈÉΩÊ≤°ÊúâÁïô‰∏ã...');
            if (newProfile === null) return; // Áî®Êà∑ÂèñÊ∂à
            
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ profile: newProfile })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `Áî®Êà∑ ${userId} ÁöÑÁÆÄ‰ªãÊõ¥Êñ∞ÊàêÂäüÔºÅ`, 'success');
                    loadUsers(); // Âà∑Êñ∞Áî®Êà∑ÂàóË°®
                } else {
                    showMessage('adminMessage', result.message || 'Êõ¥Êñ∞ÁÆÄ‰ªãÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Áî®Êà∑ÁÆÄ‰ªãÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }
        }

        // ÁºñËæëÁî®Êà∑Áä∂ÊÄÅ
        async function editUserStatus(userId, currentStatus) {
            const newStatus = prompt('ÁºñËæëÁî®Êà∑Áä∂ÊÄÅ:', currentStatus || 'ÂÆâÂ±Ö‰πê‰∏ö‰∏≠');
            if (newStatus === null) return; // Áî®Êà∑ÂèñÊ∂à
            
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', `Áî®Êà∑ ${userId} ÁöÑÁä∂ÊÄÅÊõ¥Êñ∞ÊàêÂäüÔºÅ`, 'success');
                    loadUsers(); // Âà∑Êñ∞Áî®Êà∑ÂàóË°®
                } else {
                    showMessage('adminMessage', result.message || 'Êõ¥Êñ∞Áä∂ÊÄÅÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }
        }

        // ==================== È≠îÊ≥ïÁÆ°ÁêÜÂäüËÉΩ ====================

        // Âä†ËΩΩÈ≠îÊ≥ïÂàóË°®
        async function loadMagics() {
            try {
                const response = await fetch(`${API_BASE}/admin/magics`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    displayMagics(data.data);
                } else {
                    document.getElementById('magicTable').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e53e3e;">
                            ${data.message || 'Âä†ËΩΩÈ≠îÊ≥ïÂ§±Ë¥•'}
                        </div>`;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÈ≠îÊ≥ïÂ§±Ë¥•:', error);
                document.getElementById('magicTable').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e53e3e;">
                        Âä†ËΩΩÈ≠îÊ≥ïÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï
                    </div>`;
            }
        }

        // ÊòæÁ§∫È≠îÊ≥ïÂàóË°®
        function displayMagics(magics) {
            if (!magics || magics.length === 0) {
                document.getElementById('magicTable').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        ÊöÇÊó†È≠îÊ≥ï
                    </div>`;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
            
            magics.forEach(magic => {
                html += `
                    <div style="border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 5px 0; font-size: 18px; color: #2d3748;">
                                    ${magic.name || 'Êú™ÂëΩÂêç'}
                                </h5>
                                <p style="margin: 0; font-size: 12px; color: #a0aec0;">
                                    ‰ª£Á†Å: ${magic.code}
                                </p>
                            </div>
                            <button class="action-btn" onclick="editMagic('${magic.code}')" style="padding: 8px 16px; font-size: 14px;">
                                ‚úèÔ∏è ÁºñËæëÁ≤æÂäõÊ∂àËÄó
                            </button>
                        </div>
                        <div style="background: #f7fafc; padding: 12px; border-radius: 6px; border-left: 3px solid #667eea;">
                            <p style="margin: 0 0 8px 0; font-size: 14px; color: #4a5568; line-height: 1.6;">
                                ${magic.description || 'Êó†ÊèèËø∞'}
                            </p>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <div style="background: #FFD700; color: #2d3748; padding: 8px 16px; border-radius: 6px; font-weight: bold;">
                                    ‚ö° Á≤æÂäõÊ∂àËÄó: ${magic.energyCost || 0} ÁÇπ
                                </div>
                                <div style="background: #e2e8f0; color: #4a5568; padding: 8px 16px; border-radius: 6px; text-decoration: line-through;">
                                    ÊØèÊó•Ê¨°Êï∞ÈôêÂà∂: Â∑≤ÁßªÈô§
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('magicTable').innerHTML = html;
        }

        // ÁºñËæëÈ≠îÊ≥ï
        function editMagic(code) {
            fetch(`${API_BASE}/admin/magics`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    const magic = data.data.find(m => m.code === code);
                    if (magic) {
                        showMagicEditDialog(magic);
                    }
                }
            });
        }

        // ÊòæÁ§∫È≠îÊ≥ïÁºñËæëÂØπËØùÊ°Ü
        function showMagicEditDialog(magic) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0; color: #2d3748; font-size: 20px;">
                        ‚ú® ÁºñËæëÈ≠îÊ≥ï: ${magic.name}
                    </h3>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: bold;">
                            ‚ö° Á≤æÂäõÊ∂àËÄóÔºàÁÇπÔºâ
                        </label>
                        <input type="number" id="editEnergyCost" value="${magic.energyCost || 0}" min="0" max="100"
                            style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                        <p style="margin: 8px 0 0 0; font-size: 12px; color: #a0aec0;">
                            Áî®Êà∑ÊØèÂ§©Êúâ15ÁÇπÁ≤æÂäõÔºåÊØèÂ§©ÂáåÊô®12ÁÇπÂà∑Êñ∞
                        </p>
                    </div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #92400e; line-height: 1.6;">
                            <strong>üí° Âª∫ËÆÆÈÖçÁΩÆÔºö</strong><br>
                            ‚Ä¢ Â§©ÈôçÈ£üÁâ©Ôºö3-5ÁÇπÔºàÂ∏∏Áî®ÂäüËÉΩÔºâ<br>
                            ‚Ä¢ ÊîπÂèòÂ§©Ê∞îÔºö2-3ÁÇπÔºà‰ΩéÊàêÊú¨ÂäüËÉΩÔºâ<br>
                            ‚Ä¢ È©±ÈÄêÂ∑®‰∫∫Ôºö7-10ÁÇπÔºàÈ´ò‰ª∑ÂÄºÂäüËÉΩÔºâ
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()"
                            style="padding: 10px 20px; background: #cbd5e0; color: #2d3748; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            ÂèñÊ∂à
                        </button>
                        <button onclick="saveMagicEnergyCost('${magic.code}')"
                            style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold;">
                            üíæ ‰øùÂ≠ò
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ‰øùÂ≠òÈ≠îÊ≥ïÁ≤æÂäõÊ∂àËÄó
        async function saveMagicEnergyCost(code) {
            const energyCost = parseInt(document.getElementById('editEnergyCost').value);

            if (isNaN(energyCost) || energyCost < 0) {
                alert('Á≤æÂäõÊ∂àËÄóÂøÖÈ°ªÊòØÂ§ß‰∫éÁ≠â‰∫é0ÁöÑÊï∞Â≠ó');
                return;
            }

            if (energyCost > 100) {
                alert('Á≤æÂäõÊ∂àËÄó‰∏çËÉΩË∂ÖËøá100ÁÇπ');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/magics/${code}/energy-cost`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ energyCost })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Á≤æÂäõÊ∂àËÄóÊõ¥Êñ∞ÊàêÂäü');
                    document.querySelector('div[style*="position: fixed"]').remove();
                    loadMagics();
                } else {
                    alert('‚ùå Êõ¥Êñ∞Â§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                console.error('‰øùÂ≠òÂ§±Ë¥•:', error);
                alert('‚ùå ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        // ==================== Â∑®‰∫∫ËøõÊîªÁÆ°ÁêÜÂäüËÉΩ ====================

        // Âä†ËΩΩÂ∑®‰∫∫ËøõÊîªÁä∂ÊÄÅ
        async function loadGiantAttackStatus() {
            try {
                const response = await fetch(`${API_BASE}/giant-attack/status`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    
                    // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                    document.getElementById('giantAttackStatus').textContent = data.isAttacking ? 'üëπ Ê≠£Âú®ËøõÊîª' : 'üõ°Ô∏è Êú™ËøõÊîª';
                    document.getElementById('giantAttackStatus').style.color = data.isAttacking ? '#e53e3e' : '#48bb78';
                    
                    if (data.isAttacking && data.startTime) {
                        const startTime = new Date(data.startTime).toLocaleString();
                        document.getElementById('giantAttackTime').textContent = startTime;
                    } else {
                        document.getElementById('giantAttackTime').textContent = '-';
                    }
                    
                    // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
                    loadGiantAttackHistory();
                } else {
                    showMessage('adminMessage', result.message || 'Âä†ËΩΩÂ∑®‰∫∫ËøõÊîªÁä∂ÊÄÅÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ∑®‰∫∫ËøõÊîªÁä∂ÊÄÅÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }
        }

        // Ëß¶ÂèëÂ∑®‰∫∫ËøõÊîª
        async function triggerGiantAttack() {
            if (!confirm('Á°ÆÂÆöË¶ÅËß¶ÂèëÂ∑®‰∫∫ËøõÊîªÂêóÔºü\n\n‚ö†Ô∏è Ë≠¶ÂëäÔºöÂ∑®‰∫∫ËøõÊîªÂ∞ÜÂºÄÂßãÂØπÊòüÊòüÂüéÈÄ†ÊàêÊåÅÁª≠‰º§ÂÆ≥ÔºÅ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/giant-attack/trigger`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', 'üëπ Â∑®‰∫∫ËøõÊîªÂ∑≤Ëß¶ÂèëÔºÅ', 'success');
                    loadGiantAttackStatus(); // Âà∑Êñ∞Áä∂ÊÄÅ
                } else {
                    showMessage('adminMessage', result.message || 'Ëß¶ÂèëÂ∑®‰∫∫ËøõÊîªÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ëß¶ÂèëÂ∑®‰∫∫ËøõÊîªÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }
        }

        // ÁªìÊùüÂ∑®‰∫∫ËøõÊîª
        async function endGiantAttack() {
            if (!confirm('Á°ÆÂÆöË¶ÅÁªìÊùüÂ∑®‰∫∫ËøõÊîªÂêóÔºü\n\nÂ∑®‰∫∫Â∞ÜÂÅúÊ≠¢ÂØπÊòüÊòüÂüéÁöÑ‰º§ÂÆ≥„ÄÇ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/giant-attack/end`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', 'üõ°Ô∏è Â∑®‰∫∫ËøõÊîªÂ∑≤ÁªìÊùüÔºÅ', 'success');
                    loadGiantAttackStatus(); // Âà∑Êñ∞Áä∂ÊÄÅ
                } else {
                    showMessage('adminMessage', result.message || 'ÁªìÊùüÂ∑®‰∫∫ËøõÊîªÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('ÁªìÊùüÂ∑®‰∫∫ËøõÊîªÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }
        }

        // Â§ÑÁêÜÂ∑®‰∫∫‰º§ÂÆ≥
        async function processGiantDamage() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊâãÂä®Â§ÑÁêÜÂ∑®‰∫∫‰º§ÂÆ≥ÂêóÔºü\n\nËøôÂ∞ÜÁ´ãÂç≥ÂØπÊòüÊòüÂüéÈÄ†Êàê‰∏ÄÊ¨°‰º§ÂÆ≥„ÄÇ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/giant-attack/damage`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('adminMessage', '‚öîÔ∏è Â∑®‰∫∫‰º§ÂÆ≥Â∑≤Â§ÑÁêÜÔºÅ', 'success');
                    loadGiantAttackStatus(); // Âà∑Êñ∞Áä∂ÊÄÅ
                } else {
                    showMessage('adminMessage', result.message || 'Â§ÑÁêÜÂ∑®‰∫∫‰º§ÂÆ≥Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Â§ÑÁêÜÂ∑®‰∫∫‰º§ÂÆ≥ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }
        }

        // Âä†ËΩΩÂ∑®‰∫∫ËøõÊîªÂéÜÂè≤
        async function loadGiantAttackHistory() {
            try {
                const response = await fetch(`${API_BASE}/giant-attack/admin/history`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const tbody = document.getElementById('giantAttackHistoryTable');
                    tbody.innerHTML = '';

                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">ÊöÇÊó†Â∑®‰∫∫ËøõÊîªÂéÜÂè≤</td></tr>';
                        return;
                    }

                    result.data.forEach(attack => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${attack.id}</td>
                            <td>
                                <span class="badge ${attack.isActive ? 'badge-danger' : 'badge-secondary'}">
                                    ${attack.isActive ? 'ËøõË°å‰∏≠' : 'Â∑≤ÁªìÊùü'}
                                </span>
                            </td>
                            <td>${attack.startTime ? new Date(attack.startTime).toLocaleString() : '-'}</td>
                            <td>${attack.endTime ? new Date(attack.endTime).toLocaleString() : '-'}</td>
                            <td>${attack.lastDamageTime ? new Date(attack.lastDamageTime).toLocaleString() : '-'}</td>
                            <td>${new Date(attack.createTime).toLocaleString()}</td>
                        `;
                    });
                } else {
                    showMessage('adminMessage', result.message || 'Âä†ËΩΩÂ∑®‰∫∫ËøõÊîªÂéÜÂè≤Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ∑®‰∫∫ËøõÊîªÂéÜÂè≤ÈîôËØØ:', error);
                showMessage('adminMessage', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }
        }
    </script>
</body>
</html>
