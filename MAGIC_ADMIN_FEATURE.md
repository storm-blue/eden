# ✨ 魔法管理后台功能

## 📋 功能概述

管理后台现在可以编辑魔法的精力消耗值了！管理员可以灵活调整每个魔法的精力成本，平衡游戏体验。

## 🎯 功能特性

### 可编辑的内容
- ✅ **精力消耗** - 每个魔法消耗的精力点数（0-100点）

### 不可编辑的内容
- ❌ **魔法代码** (code) - 系统内部标识，不可修改
- ❌ **魔法名称** (name) - 固定的魔法名称
- ❌ **魔法描述** (description) - 固定的功能说明
- ❌ **每日次数限制** - 已移除，不再生效

## 🖥️ 使用方法

### 1. 访问管理后台

1. 打开管理后台：`http://localhost:8081/admin.html`
2. 使用管理员账号登录
3. 点击顶部导航栏的 **"魔法管理"** 标签

### 2. 查看魔法列表

魔法管理页面会显示所有魔法的信息：

```
┌─────────────────────────────────────────┐
│ ✨ 魔法管理                              │
│                                          │
│ 管理魔法的精力消耗值                     │
│ （注意：已移除每日次数限制，仅精力限制生效）│
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 天降食物                [✏️ 编辑精力消耗] │ │
│ │ 代码: FOOD_RAIN                      │ │
│ │ 施展魔法后，将会有10000份食物从天而降...│ │
│ │                                      │ │
│ │ ⚡ 精力消耗: 5 点                     │ │
│ │ 每日次数限制: 已移除                 │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 改变天气                [✏️ 编辑精力消耗] │ │
│ │ ...                                  │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 3. 编辑精力消耗

1. 点击魔法卡片右上角的 **"✏️ 编辑精力消耗"** 按钮
2. 在弹出的对话框中修改精力消耗值（0-100）
3. 查看建议配置参考
4. 点击 **"💾 保存"** 按钮

#### 编辑对话框示例

```
┌──────────────────────────────────┐
│ ✨ 编辑魔法: 天降食物              │
│                                   │
│ ⚡ 精力消耗（点）                 │
│ ┌─────────────────────────────┐ │
│ │ [  5  ]                      │ │
│ └─────────────────────────────┘ │
│ 用户每天有15点精力，每天凌晨12点刷新│
│                                   │
│ 💡 建议配置：                     │
│ • 天降食物：3-5点（常用功能）     │
│ • 改变天气：2-3点（低成本功能）   │
│ • 驱逐巨人：7-10点（高价值功能）  │
│                                   │
│         [取消]  [💾 保存]        │
└──────────────────────────────────┘
```

### 4. 保存并生效

- ✅ 保存后**立即生效**
- ✅ 无需重启服务器
- ✅ 用户下次施展魔法时使用新的精力消耗值

## 📊 当前魔法配置

### 默认精力消耗

| 魔法代码 | 魔法名称 | 精力消耗 | 功能说明 |
|---------|---------|---------|---------|
| `FOOD_RAIN` | 天降食物 | **5点** ⚡⚡⚡⚡⚡ | 增加10000食物 |
| `CHANGE_WEATHER` | 改变天气 | **3点** ⚡⚡⚡ | 立即刷新天气 |
| `BANISH_GIANT` | 驱逐巨人 | **8点** ⚡⚡⚡⚡⚡⚡⚡⚡ | 停止巨人进攻 |

### 精力系统规则

- **每日精力总量**：15点
- **刷新时间**：每天凌晨12点
- **消耗规则**：施展魔法时扣除相应精力
- **限制**：精力不足时无法施展魔法

## 💡 配置建议

### 平衡性原则

1. **总精力限制**：用户每天只有15点精力
2. **功能价值**：根据魔法的游戏价值设定消耗
3. **灵活搭配**：允许多种组合方式

### 推荐配置方案

#### 方案1：均衡型（当前默认）
```
天降食物：5点（可施展3次）
改变天气：3点（可施展5次）
驱逐巨人：8点（可施展1次+剩余7点）
```
**特点**：平衡各种需求，适合大多数场景

#### 方案2：降低天降食物成本
```
天降食物：3点（可施展5次）
改变天气：2点（可施展7次）
驱逐巨人：10点（可施展1次+剩余5点）
```
**特点**：鼓励更频繁使用天降食物，提高食物获取

#### 方案3：提高驱逐巨人价值
```
天降食物：5点
改变天气：3点
驱逐巨人：6点（可施展2次）
```
**特点**：降低驱逐巨人成本，应对巨人更容易

#### 方案4：免费魔法（测试用）
```
所有魔法：0点
```
**特点**：无限制施展，用于测试或特殊活动

### 配置注意事项

1. **最低值**：建议不低于2点（保持游戏策略性）
2. **最高值**：建议不超过10点（避免过于限制）
3. **总量考虑**：确保用户能在一天内使用多次魔法
4. **差异化**：不同魔法的成本应有明显区别

## 🔧 技术实现

### 后端 API

#### 1. 获取魔法列表
```http
GET /api/admin/magics
Headers:
  Authorization: Bearer {adminToken}

Response:
{
  "success": true,
  "message": "获取魔法列表成功",
  "data": [
    {
      "id": 1,
      "code": "FOOD_RAIN",
      "name": "天降食物",
      "description": "施展魔法后，将会有10000份食物从天而降...",
      "dailyLimit": 3,
      "remainingUses": 3,
      "energyCost": 5,
      "lastRefreshAt": "2024-10-19T12:00:00",
      "createdAt": "2024-10-19T00:00:00"
    },
    ...
  ]
}
```

#### 2. 更新精力消耗
```http
PUT /api/admin/magics/{code}/energy-cost
Headers:
  Authorization: Bearer {adminToken}
  Content-Type: application/json

Body:
{
  "energyCost": 5
}

Response:
{
  "success": true,
  "message": "魔法精力消耗更新成功"
}
```

### 数据库操作

```sql
-- 查询所有魔法
SELECT id, code, name, description, daily_limit, remaining_uses, 
       energy_cost, last_refresh_at, created_at
FROM magic
ORDER BY id;

-- 更新精力消耗
UPDATE magic
SET energy_cost = 5
WHERE code = 'FOOD_RAIN';
```

### 修改的文件

#### 前端
- ✅ `/eden-server/src/main/resources/static/admin.html`
  - 添加魔法管理标签页
  - 添加 `loadMagics()` 函数
  - 添加 `displayMagics()` 函数
  - 添加 `editMagic()` 函数
  - 添加 `showMagicEditDialog()` 函数
  - 添加 `saveMagicEnergyCost()` 函数

#### 后端
- ✅ `/eden-server/src/main/java/com/eden/lottery/controller/AdminController.java`
  - 添加 `@GetMapping("/magics")` - 获取魔法列表
  - 添加 `@PutMapping("/magics/{code}/energy-cost")` - 更新精力消耗

- ✅ `/eden-server/src/main/java/com/eden/lottery/service/MagicService.java`
  - 添加 `updateMagicEnergyCost()` 方法

- ✅ `/eden-server/src/main/java/com/eden/lottery/mapper/MagicMapper.java`
  - 添加 `updateEnergyCost()` 接口

- ✅ `/eden-server/src/main/resources/mapper/MagicMapper.xml`
  - 添加 `updateEnergyCost` SQL 实现

## ✅ 验证方法

### 1. 访问管理后台
```bash
# 打开浏览器访问
open http://localhost:8081/admin.html
```

### 2. 检查魔法列表
- 登录管理后台
- 点击"魔法管理"标签
- 确认显示所有魔法及其精力消耗

### 3. 修改精力消耗
- 点击"编辑精力消耗"按钮
- 修改数值（如：天降食物改为3点）
- 保存并确认成功提示

### 4. 验证生效
```sql
-- 在数据库中检查
sqlite3 /Users/g01d-01-0924/eden/eden-server/eden_lottery.db
SELECT code, name, energy_cost FROM magic;
```

### 5. 用户端测试
- 让用户进入星星城
- 点击"施展魔法"
- 确认显示的精力消耗是新值
- 施展魔法后验证精力扣除正确

## 🎮 使用场景

### 场景1：日常运营
管理员根据游戏数据调整魔法成本，平衡游戏经济。

### 场景2：特殊活动
临时降低某些魔法的成本，作为活动福利。

### 场景3：紧急调整
发现某个魔法过于强大或弱小，快速调整平衡。

### 场景4：测试验证
设置为0点消耗，快速测试魔法功能。

## 📚 相关文档

- [ENERGY_SYSTEM.md](./ENERGY_SYSTEM.md) - 精力系统说明
- [ENERGY_ONLY_UPDATE.md](./ENERGY_ONLY_UPDATE.md) - 移除次数限制更新
- [MAGIC_SYSTEM.md](./MAGIC_SYSTEM.md) - 魔法系统说明

## 🔒 权限说明

- ✅ 仅管理员可访问
- ✅ 需要有效的管理员 Token
- ✅ 所有操作都会记录日志

## 🐛 常见问题

### Q: 修改后用户看不到新的精力消耗？
A: 请刷新用户页面，精力消耗是从后端实时获取的。

### Q: 可以设置为负数吗？
A: 不可以，后端会验证精力消耗必须 >= 0。

### Q: 可以超过15点吗？
A: 可以设置超过15点，但用户每天只有15点精力，实际上一天只能施展1次。

### Q: 修改后旧的魔法使用记录会受影响吗？
A: 不会，只影响新的魔法施展。

### Q: 可以恢复默认值吗？
A: 可以，手动改回默认值即可：
  - 天降食物：5点
  - 改变天气：3点
  - 驱逐巨人：8点

---

**更新时间**：2024-10-19  
**版本**：v1.0.0  
**状态**：✅ 已完成，可立即使用

