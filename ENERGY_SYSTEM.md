# ⚡ 精力系统文档

## 📖 系统概述

精力系统是为星星城魔法功能设计的资源管理机制。用户每天拥有固定的精力值，施展不同魔法会消耗对应的精力。

## 🎮 基本规则

### 精力上限
- 每个用户每天有 **15点精力**
- 精力值不会超过上限
- 每天凌晨12点自动恢复到满值（15点）

### 精力消耗
| 魔法名称 | 精力消耗 | 每日次数 | 效果 |
|---------|----------|----------|------|
| 天降食物 | **5点** ⚡⚡⚡⚡⚡ | 3次 | 食物+10000 |
| 改变天气 | **3点** ⚡⚡⚡ | 3次 | 立即刷新天气 |
| 驱逐巨人 | **8点** ⚡⚡⚡⚡⚡⚡⚡⚡ | 1次 | 停止巨人进攻 |

### 施展限制
1. **精力不足**：无法施展魔法，显示提示信息
2. **次数用完**：即使有精力也无法施展
3. **双重限制**：必须同时满足精力和次数要求

## 📊 计算示例

### 示例1：合理规划
秦小淮今天的魔法规划：

1. **早上8点**：施展"天降食物"
   - 精力：15 - 5 = **10点剩余** ✅
   
2. **中午12点**：施展"改变天气"
   - 精力：10 - 3 = **7点剩余** ✅
   
3. **下午3点**：施展"改变天气"
   - 精力：7 - 3 = **4点剩余** ✅
   
4. **下午6点**：想施展"天降食物"
   - 需要5点，只有4点 ❌
   - **精力不足，无法施展！**
   
5. **晚上9点**：施展"改变天气"
   - 精力：4 - 3 = **1点剩余** ✅
   
6. **第二天凌晨**：精力自动恢复到15点 🌅

### 示例2：紧急情况
星星城遭遇巨人进攻！

1. **当前精力**：9点
2. **需要施展**："驱逐巨人"（消耗8点）
3. **结果**：9 - 8 = **1点剩余** ✅
4. **巨人被驱逐**！但精力几乎耗尽

### 示例3：精力不足
1. **当前精力**：4点
2. **想施展**："天降食物"（需要5点）
3. **提示**："精力不足！需要 5 点精力，当前只有 4 点"
4. **解决方案**：
   - 等待第二天凌晨恢复
   - 或者先施展消耗较少的魔法

## 💡 策略建议

### 高效策略
1. **优先级排序**：
   - 紧急情况（巨人进攻）→ 优先施展"驱逐巨人"
   - 日常需求 → 根据食物和天气情况决定
   
2. **精力分配**：
   - 保留足够精力应对突发情况
   - 驱逐巨人需要8点，建议保留至少8点精力
   
3. **最大化利用**：
   - 每天可施展的魔法组合示例：
     - 天降食物(5) + 天降食物(5) + 改变天气(3) = 13点 ✅
     - 驱逐巨人(8) + 改变天气(3) + 改变天气(3) = 14点 ✅
     - 天降食物(5) + 驱逐巨人(8) = 13点 ✅

### 常见错误
1. ❌ 一天内施展所有次数但精力不够
   - 例如：3次天降食物 = 15点，刚好用完
   - 但如果出现巨人进攻，就无法应对
   
2. ❌ 忽略精力消耗，只看次数
   - 每个魔法的精力消耗不同
   - 需要同时管理精力和次数

## 🔧 技术实现

### 数据库表结构
```sql
-- users 表
ALTER TABLE users ADD COLUMN energy INTEGER NOT NULL DEFAULT 15;
ALTER TABLE users ADD COLUMN max_energy INTEGER NOT NULL DEFAULT 15;
ALTER TABLE users ADD COLUMN energy_refresh_time DATETIME;

-- magic 表
ALTER TABLE magic ADD COLUMN energy_cost INTEGER NOT NULL DEFAULT 5;
```

### 精力消耗流程
```
1. 用户点击"施展魔法"
   ↓
2. 前端检查精力是否足够
   ↓
3. 后端再次检查精力和次数
   ↓
4. 消耗精力：energy = energy - energyCost
   ↓
5. 减少次数：remainingUses = remainingUses - 1
   ↓
6. 执行魔法效果
   ↓
7. 返回最新精力信息
```

### 精力刷新机制
```
每天凌晨12点（定时任务）：
1. 重置所有用户精力：energy = maxEnergy (15)
2. 更新刷新时间：energyRefreshTime = now()
3. 重置魔法次数：remainingUses = dailyLimit
```

## 📱 用户界面

### 魔法弹窗显示
```
┌─────────────────────────────────────┐
│        ✨ 魔法管理                  │
│  ┌───────────────────────────────┐ │
│  │    ⚡ 当前精力                 │ │
│  │        15 / 15                │ │
│  │  每天凌晨12点恢复到满值         │ │
│  └───────────────────────────────┘ │
│                                     │
│  ▼ 天降食物 (3/3)   [施展魔法]      │
│    ⚡ 精力消耗: 5                  │
│                                     │
│  ▼ 改变天气 (3/3)   [施展魔法]      │
│    ⚡ 精力消耗: 3                  │
│                                     │
│  ▼ 驱逐巨人 (1/1)   [施展魔法]      │
│    ⚡ 精力消耗: 8                  │
└─────────────────────────────────────┘
```

### 精力显示颜色
- **足够**（绿色/金色）：精力 >= 魔法消耗
- **不足**（红色）：精力 < 魔法消耗

## 🐛 错误提示

### 精力不足
```
精力不足！需要 5 点精力，当前只有 3 点
```

### 次数用完
```
今日魔法次数已用完，请明日再来
```

### 双重限制
```
1. 检查精力（前端+后端）
2. 检查次数（后端）
```

## 🎯 游戏平衡

### 设计考量
1. **总精力15点**：
   - 不能施展所有魔法的所有次数
   - 需要策略性选择
   
2. **精力消耗差异**：
   - 天降食物（5点）：基础魔法，常用
   - 改变天气（3点）：低成本，频繁使用
   - 驱逐巨人（8点）：高成本，应急使用
   
3. **平衡性**：
   - 每天可施展约3-5次魔法
   - 强制玩家做出选择
   - 增加游戏策略性

## 🔄 更新日志

### v1.0.0 (2024-10-19)
- ✅ 初始实现精力系统
- ✅ 数据库表结构迁移
- ✅ 后端精力检查和消耗
- ✅ 前端精力显示
- ✅ 每日自动刷新

## 📞 常见问题

**Q: 精力什么时候恢复？**
A: 每天凌晨12点自动恢复到满值（15点）

**Q: 可以手动恢复精力吗？**
A: 不可以，只能等待每日自动刷新

**Q: 精力不够怎么办？**
A: 
1. 等待第二天凌晨恢复
2. 先施展消耗较少的魔法
3. 合理规划每天的魔法使用

**Q: 为什么施展魔法失败？**
A: 可能原因：
1. 精力不足
2. 今日次数已用完
3. 网络错误

**Q: 精力系统的意义是什么？**
A: 
1. 增加游戏策略性
2. 避免魔法滥用
3. 鼓励合理规划
4. 平衡游戏进度

---

💫 享受魔法的力量，但请明智地使用你的精力！⚡✨

